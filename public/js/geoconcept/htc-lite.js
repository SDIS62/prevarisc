var GCUI=GCUI||{};GCUI.Layer=GCUI.Layer||{};GCUI.Layer.GeoConcept=OpenLayers.Class(OpenLayers.Layer.WMTS,{isBaseLayer:true,projection:"EPSG:27572",maxExtent:new OpenLayers.Bounds(0,0,0,0),units:"m",tileSize:new OpenLayers.Size(300,300),numZoomLevels:12,format:"image/png",initialize:function(d,c,e,b){this.projection=new OpenLayers.Projection(this.projection);
this.addOptions(e);var a={name:d,url:c,params:e};a=OpenLayers.Util.applyDefaults(a,{layer:e.layer,style:e.tabname,matrixSet:e.matrixSet});a=OpenLayers.Util.applyDefaults(a,b);OpenLayers.Layer.WMTS.prototype.initialize.apply(this,[a]);delete this.params.MAPNAME;delete this.params.TABNAME;this.initFormat();
this.url=this.getUrlGC()+"/wmts";this.readMetadata();this.checkMetadata()},initFormat:function(){this.extension=(this.extension==="jpeg")?"jpg":this.extension;if(this.extension==="pngt"){this.transparent=true}if(this.extension==="png24"){this.extension="png"}if(this.extension!=="png"&&this.extension!=="jpg"){this.extension="png"
}this.format="image/"+this.extension},readMetadata:function(){},getUrlGC:function(){var a=OpenLayers.Util.isArray(this.url)?this.url[0]:this.url;var b=a.lastIndexOf("/maps")!==-1?a.lastIndexOf("/maps"):a.lastIndexOf("/wmts");if(b!==-1){a=a.substring(0,b)}if(a[a.length-1]==="/"){a=a.substring(0,a.length-1)
}return a},loadMetadata:function(){var b=new OpenLayers.Protocol.Script({url:this.getUrlGC()+"/api/lbs/layer/json",format:new OpenLayers.Format()});var a={map:this.getMapName().replace(".gcm",""),tab:this.style};if(this.layer){a={name:this.layer}}if(GCUI.Settings){OpenLayers.Util.applyDefaults(a,GCUI.Settings);
OpenLayers.Util.applyDefaults(this.params,GCUI.Settings);if(GCUI.Settings.forceUpdate){a.tick=new Date().getTime()}}b.createRequest(b.url,a,OpenLayers.Function.bind(this.processMetadata,this))},writeMetadata:function(a){},processMetadata:function(g){if(this.initialized){return}if(g&&g.status==="ERROR"){GCUI.Console.error(this.CLASS_NAME+" : "+g.message);
return}var d=g.result;this.mapname=d.map;this.tabname=d.tab||d.tabname;this.writeMetadata(d);var f=d.ratios;var h=d.precision;this.metadata.precision=h;var e=d.extent;this.layer=this.layer||d.name;this.matrixSet=this.matrixSet||d.projection;this.projection=new OpenLayers.Projection(d.projection);this.style=this.tabname;
this.extension=d.format;this.initFormat();if(d.tileWidth&&!this.singleTile){this.tileSize=new OpenLayers.Size(d.tileWidth,d.tileHeight)}OpenLayers.Util.applyDefaults(this.params,{layerVersion:d.layerVersion||d.version});var c=this.layer?this.layer:(this.getMapName().replace(".gcm","")+"."+this.tabname);
GCUI.Layer.GeoConcept.DATA[c]=g;if(e&&f){this.maxExtent=new OpenLayers.Bounds(h*e.minX,h*e.minY,h*e.maxX,h*e.maxY);this.resolutions=[];for(var b=0,a=f.length;b<a;b++){if((b%2)===0){this.resolutions.push(h/parseFloat(f[b]))}}}else{this.resolutions=this.map.baseLayer.resolutions;this.maxExtent=this.map.baseLayer.maxExtent
}if(this.beforeInitLayer()){this.initLayer()}},beforeInitLayer:function(){if(this.singleTile&&!this.userId){GCUI.getUserId((this.url instanceof Array)?this.url[0]:this.url,this.getMapName(),OpenLayers.Function.bind(function(a){this.userId=a;this.initLayer()},this));return false}return true},initLayer:function(){if(this.initialized&&!this.ratios){return
}this.initialized=true;this.addOptions({resolutions:this.resolutions,maxExtent:this.maxExtent,tileFullExtent:this.maxExtent,tileOrigin:new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.top)});if(this.map&&this!=this.map.baseLayer){this.redraw();this.map.events.triggerEvent("changelayer",{layer:this,property:"params"})
}this.events.triggerEvent("init")},setMap:function(a){OpenLayers.Layer.Grid.prototype.setMap.apply(this,[a])},checkMetadata:function(){if(this.initialized){return}var a=this.layer?this.layer:(this.getMapName().replace(".gcm","")+"."+this.tabname);var b=GCUI.Layer.GeoConcept.DATA[a];if(b){this.processMetadata(b)
}else{if(this.visibility||this.initMapInformations){this.loadMetadata()}else{this.events.on({visibilitychanged:this.checkMetadata,scope:this})}}},clone:function(a){if(a==null){a=new GCUI.Layer.GeoConcept(this.name,this.url,this.params,this.options)}a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a]);
return a},getMapName:function(){var a=this.mapname||"";if(a===""&&this.map&&this.map.baseLayer){a=this.map.baseLayer.mapname||""}if(this.singleTile&&a!==""){a+=((a.indexOf(".gcm")===-1)?".gcm":"")}return a},getURL:function(c){if(!this.initialized){return OpenLayers.Util.getImagesLocation()+"blank.gif"
}if(!this.singleTile){return OpenLayers.Layer.WMTS.prototype.getURL.apply(this,[c])}else{var b=this.tileSize;var g=this.map.getLogicalScale();var a=this.url;if(a instanceof Array){a=this.selectUrl(e,a)}a=a.substring(0,a.lastIndexOf("/wmts"))+"/gcservlet?";var f=this.metadata.precision;var d=c.left/f+","+c.bottom/f+","+c.right/f+","+c.top/f;
var e=["XgoAnswer=MapImage","XgoMapFile="+this.getMapName(),this.tabname?"XgoTabs="+this.tabname:"","sizex="+b.w,"sizey="+b.h,"XgoSetLogicalScale="+g,"XgoSetViewBounds="+d,"XgoBitmapFormat=PNG","XgoNbBits=24","tr="+(this.transparent?"-1":"0"),"XgoTransparentBackGround=true","XgoSetViewBoundsExtraPixels=0","XgoSetViewBoundsFitUpperLS=false",this.userId?("XgoUserID="+this.userId):"","tick="+new Date().getTime()].join("&");
return a+e+(this.urlParams||"")}},moveTo:function(b,a,c){if(!this.initialized){return}OpenLayers.Layer.WMTS.prototype.moveTo.apply(this,arguments)},CLASS_NAME:"GCUI.Layer.GeoConcept"});GCUI.Layer.GeoConcept.DATA=[];GCUI.Layer=GCUI.Layer||{};GCUI.Layer.Object=OpenLayers.Class(OpenLayers.Layer,{displayInLayerSwitcher:false,initialize:function(a){OpenLayers.Layer.prototype.initialize.apply(this,["objects",a]);
this.objects=[];this.isIpad=(navigator.userAgent.match(/iPad/i)!=null);return this},setMap:function(a){OpenLayers.Layer.prototype.setMap.apply(this,[a]);this.onAddLayerFunction=OpenLayers.Function.bind(function(){this.setLayerIndex(this.objectLayer,this.layers.length)},this.map);this.map.events.register("addlayer",this.map,this.onAddLayerFunction);
this.div.className="mapobjects";this.div.id="mapobjects";this.dirty=false},removeMap:function(a){this.map.events.unregister("addlayer",this.map,this.onAddLayerFunction);this.onAddLayerFunction=null;this.map.objectLayer=null},remove:function(a){this.div.parentNode.removeChild(this.div)},getInfoEvent:function(){return(this.isIpad?"ontouchend":"onclick")
},create:function(s){var c=0;var q=null;var p="mapobjectname";var a=this.objects.length;var k=this.map.div.id;var n='<div id="'+k+"_obj_";var t=this.getInfoEvent();var m='" ';var l=' style="position:absolute;" class="mapobject" > </div>';var j=' style="position:absolute;" class="mapobject" >';var i="</div>";
var h='<img src="';var g='" id="'+k+"_obj_";var f='" class="mapobject" ';var u='<div class="';var r='" id="'+k+"_objname_";var e=" >";var v=[];var o;for(c=0;c<a;c++){q=this.objects[c];if(q.type){v.push(n);v.push(c);v.push(m);v.push(l)}else{if(q.innerHTML){v.push(n);v.push(c);v.push(m);v.push(j);v.push(q.innerHTML);
v.push(i)}else{v.push(h);v.push(q.imgsrc);v.push(g);v.push(c);v.push(f);v.push(" />")}}if(q.name){if(q.objnamecss){p=q.objnamecss}o="";if(q.nameBackgroundColor){o="style=background-color:"+q.nameBackgroundColor+";"}v.push(u);v.push(p);v.push(r);v.push(c);v.push(m);v.push(o);v.push(e);v.push(q.name);v.push(i)
}}s.innerHTML=v.join("");var d=k+"_obj_";var b=k+"_objname_";var w=document;for(c=0;c<a;c++){q=this.objects[c];q.mainDiv=w.getElementById(d+c);q.mainDiv[t]=OpenLayers.Function.bindAsEventListener(function(x){OpenLayers.Event.stop(x);DynMapShowObjectSheet(DynMapGetMap(document,k),this.id)},q);if(q.name){q.nameDiv=w.getElementById(b+c);
q.nameDiv[t]=OpenLayers.Function.bindAsEventListener(function(x){OpenLayers.Event.stop(x);DynMapShowObjectSheet(DynMapGetMap(document,k),this.id)},q)}}this.dirty=false},moveObject:function(b,d){var c=this.findObject(b.id);if(!c){return false}c.text=b.text;c.mapx=parseFloat(b.mapx);c.mapy=parseFloat(b.mapy);
var a=(c.innerHTML!==null&&c.innerHTML!=b.innerHTML);if(a){c.innerHTML=b.innerHTML}if(d){c.mapx/=this.map.precision;c.mapy/=this.map.precision}if(!this.map.dragging&&!this.map.scrolling&&c.mainDiv){this.updateObject(c,a)}return true},moveObjects:function(e,d){var c;var b=true;var a=e.length;for(c=0;c<a;
c++){b=b&&this.moveObject(e[c],d)}return b},addObject:function(a,c){var b={};if(a.id!==null){b.id=a.id}else{b.id=a.name}b.mapx=parseFloat(a.mapx);b.mapy=parseFloat(a.mapy);b.name=a.name;b.text=a.text;b.deltaX=a.deltaX;b.deltaY=a.deltaY;b.imgsrc=a.imgsrc;b.width=a.width;b.innerHTML=a.innerHTML;b.type=a.type;
b.objnamecss=a.objnamecss;b.nameBackgroundColor=a.nameBackgroundColor;if(a.visMinScale){b.visMinScale=a.visMinScale}if(a.visMaxScale){b.visMaxScale=a.visMaxScale}if(c){b.mapx/=this.map.precision;b.mapy/=this.map.precision}this.objects.push(b);this.dirty=true},removeObject:function(d){var c=[];var e=this.objects;
var b;var a=e.length;for(b=0;b<a;b++){if(e[b].id!==d){c.push(e[b])}}this.objects=c;this.dirty=true},getNumObject:function(b){var d,a,c;if(b){d=this.objects;c=d.length;for(a=0;a<c;a++){if(d[a].id==b){return a}}}},getObjectXY:function(b,e){var d=this.findObject(b);var c=[];var a,f;if(d){a=e?d.mapx*this.map.precision:d.mapx;
f=e?d.mapy*this.map.precision:d.mapy;c.push(a);c.push(f)}return c},setObjectNameCss:function(a,b){var c=this.findObject(a);if(!c){return}c.objnamecss=b;c.nameDiv.className=b},setObjectDivCss:function(b,a){var c=this.findObject(b);c.mainDiv.className=a},addObjects:function(d,c){var b;var a=d.length;for(b=0;
b<a;b++){this.addObject(d[b],c)}},getCSS:function(b,a){var d="";var c;if(!b){return""}if(b.currentStyle){c=a.replace(/\-(.)/g,function(e,f){return f.toUpperCase()});d=b.currentStyle[c]}else{if(window.getComputedStyle){d=document.defaultView.getComputedStyle(b,null).getPropertyValue(a)}}return d},_getObjImgSrc:function(a){for(var b=0;
b<a.childNodes.length;b++){if(a.childNodes[b].src){return a.childNodes[b].src}else{return(this._getObjImgSrc(a.childNodes[b]))}}},transformLabel:function(a){return a},toJSON:function(){var s,o,t,g,j,c,k,m,b,a,x,v,l,h;var e=this.objects.length;var u="";var q=this.map.precision;var f=this.map.div.id+"_obj_";
var d=this.map.div.id+"_objname_";var r=this.getCSS;var w=document;var n=this.map.getExtent();for(s=0;s<e;s++){o=this.objects[s];if(n.containsLonLat(new OpenLayers.LonLat(o.mapx*q,o.mapy*q))){j='{"text":"'+this.transformLabel(o.name)+'",';l=w.getElementById(d+s);j+='"bgcol":"'+r(l,"background-color")+'",';
j+='"color":"'+r(l,"color")+'",';j+='"font":"'+r(l,"font-family")+'",';j+='"fontsize":"'+r(l,"font-size")+'",';j+='"hotspot":[0,0],"delta":['+(8-o.deltaX)+","+(-32-o.deltaY)+"]}";u+='{"type":"point","center":['+o.mapx*q+","+o.mapy*q+"]";if(o.type){t=o.type.getStyle(DynMapGetScale(this.map));if(t.icon){h=w.getElementById(f+s);
g=r(h,"background-image");g=g.replace("url(","").replace(")","").replace('"',"").replace('"',"");u+=',"style":{"type":"image","url":"'+g+'"}'}else{c=t.width;k=t.height;b="[0,0]";a="["+c+",0]";x="["+c+","+k+"]";v="[0,"+k+"]";m="["+b+","+a+","+x+","+v+","+b+"]";u+=',"style":{"type":"polygon","polygon":'+m+',"lineColor":"'+t.borderColor+'","lineWidth":'+t.borderWidth+',"opacity":'+(t.bgOpacity*100)+',"order":0,"fillColor":"'+t.bgColor+'"}'
}u+=',"hotspot":['+t.hotSpotX+","+t.hotSpotY}else{g=w.getElementById(f+s).src;if(!g){g=this._getObjImgSrc(o.mainDiv)}u+=',"label":'+j+',"style":{"type":"image","url":"'+g+'"}';u+=',"hotspot":['+(-o.deltaX)+","+(-o.deltaY)}u+='],"order":'+s+"},"}}if(u!==""){u=u.substring(0,u.length-1)}return u},clearObjects:function(){this.objects.length=0;
this.dirty=true},findObject:function(a){var e=null;var d,b,c;if(a){d=this.objects;b=0;c=d.length;for(b=0;b<c;b++){if(d[b].id==a){e=d[b];break}}}return e},setDragMode:function(a){this.dragMode=a},moveTo:function(b,a,c){OpenLayers.Layer.prototype.moveTo.apply(this,[b,a,c]);this.divLeft=parseInt(this.map.layerContainerDiv.style.left);
this.divTop=parseInt(this.map.layerContainerDiv.style.top);this.div.style.left=-this.divLeft+"px";this.div.style.top=-this.divTop+"px";this.refresh();this.drawn=true},refresh:function(c){if(this.updating||!this.getVisibility()){return}this.updating=true;if(this.dirty){this.create(this.div);c=true}var a=0;
var b=this.objects.length;if(this.multiLabels){this.nbObjsInPosXY=[]}for(a=0;a<b;a++){this.updateObject(this.objects[a],c)}this.updating=false},displayObj:function(b,a){b.mainDiv.style.display=a;if(b.nameDiv){this.displayName(b,a)}},displayName:function(b,a){b.nameDiv.style.display=a},updateObject:function(f,a){if(!f.mainDiv){return
}f.posx=DynMapCalcPixelX(this.map,f.mapx);f.posy=DynMapCalcPixelY(this.map,f.mapy);if(this.multiLabels){var g=f.posx+"_"+f.posy;if(!this.nbObjsInPosXY[g]){this.nbObjsInPosXY[g]=1}else{this.nbObjsInPosXY[g]=this.nbObjsInPosXY[g]+1}}var b=true;var e=0;var h,c,j,i;if((f.posx>this.map.size.w+e)||(f.posx<=-e)||(f.posy>this.map.size.h+e)||(f.posy<=-e)){b=false
}if(b){if(!f.visible&&f.mainDiv){this.displayObj(f,"block");f.visible=true}if(f.type){this.updateObjectStyle(f,a)}else{if(a&&f.innerHTML&&!this.dragMode){f.mainDiv.innerHTML=f.innerHTML}j=(f.mainDiv&&f.mainDiv.width)?-f.mainDiv.width/2:0;i=(f.mainDiv&&f.mainDiv.height)?-f.mainDiv.height/2:0;if(!f.deltaX){f.deltaX=j
}if(!f.deltaY){f.deltaY=i}f.mainDiv.style.left=(f.posx+f.deltaX)+"px";f.mainDiv.style.top=(f.posy+f.deltaY)+"px";var d=DynMapGetScale(this.map);if(f.visMinScale){if(f.visMinScale<=d&&f.visMaxScale>d){this.displayObj(f,"block")}else{this.displayObj(f,"none")}}if(f.nameDiv){if(this.multiLabels){h=this.nbObjsInPosXY[f.posx+"_"+f.posy];
c=f.nameDiv.clientWidth;f.nameDiv.style.left=(f.posx-f.deltaX+(Math.floor(h/9))*c+c*this.deltaPosNameX[(h-1)%8])+"px";f.nameDiv.style.top=(f.posy+f.deltaY+(Math.floor(h/9))*c-this.deltaPosNameY[(h-1)%8])+"px"}else{f.nameDiv.style.left=(f.posx+(j===0?0:(f.deltaX-j))+8)+"px";f.nameDiv.style.top=(f.posy+(i===0?0:(f.deltaY-i))-32)+"px"
}if(this.namedivminscale){if(this.namedivminscale<=d&&this.namedivmaxscale>d){this.displayName(f,"block")}else{this.displayName(f,"none")}}}}}else{if(f.visible){this.displayObj(f,"none");f.visible=false}}},setNameDivVisibilityRange:function(a,b){this.namedivminscale=a;this.namedivmaxscale=b},activateMultiLabels:function(){this.multiLabels=true;
this.nbObjsInPosXY=[];this.deltaPosNameX=[0,0,0,-1,-2,-2,-2,-1];this.deltaPosNameY=[22,5,-12,-12,-12,5,22,22]},updateObjectStyle:function(f,c){var a,d;var h=f.type;var m,l,k,j,i,b,g;if(h&&f.mainDiv){var e=DynMapGetScale(this.map);d=f.mainDiv.style;a=h.getStyle(e);m=a?a.hotSpotX:f.mainDiv.width/2;l=a?a.hotSpotY:f.mainDiv.height/2;
d.left=(f.posx-m)+"px";d.top=(f.posy-l)+"px";if(c||a!=f.currentStyle){f.currentStyle=a;d.width=a.width+"px";d.height=a.height+"px";d.padding=0;d.margin=0;if(a.bgColor){d.backgroundColor=a.bgColor}else{d.backgroundColor="transparent"}if(a.borderColor&&a.borderWidth){d.borderColor=a.borderColor;d.borderStyle="solid";
d.borderWidth=a.borderWidth}else{d.borderStyle="none"}d.opacity=a.bgOpacity;if(a.icon){d.backgroundImage="url("+a.icon+")"}else{d.backgroundImage="none"}}if(f.nameDiv){if(a.objnamecss){this.displayName(f,"block");if(this.multiLabels){k=this.nbObjsInPosXY[f.posx+"_"+f.posy];if(!f.nameW){f.nameW=f.nameDiv.clientWidth
}b=Math.floor(k/9)*f.nameW;g=(k-1)%8;f.nameDiv.style.left=(f.posx-f.deltaX+b+f.nameW*this.deltaPosNameX[g])+"px";f.nameDiv.style.top=(f.posy+f.deltaY+b-this.deltaPosNameY[g])+"px"}else{j=a.width/2-a.hotSpotX;i=a.height/2-a.hotSpotY;f.nameDiv.style.left=(f.posx+j+8)+"px";f.nameDiv.style.top=(f.posy+i-32)+"px"
}f.nameDiv.className=a.objnamecss;if(this.namedivminscale){if(this.namedivminscale<=e&&this.namedivmaxscale>e){this.displayName(f,"block")}else{this.displayName(f,"none")}}}else{this.displayName(f,"none")}}}},getDataExtent:function(){var b=null;var e=this.objects;if(e&&(e.length>0)){b=new OpenLayers.Bounds();
var g=null;var c=this.map.precision;for(var d=0,a=e.length;d<a;d++){var f=e[d];g=new OpenLayers.Geometry.Point(f.mapx*c,f.mapy*c);if(g){b.extend(g.getBounds())}}}return b},CLASS_NAME:"GCUI.Layer.Object"});function GCISObjectType(a,b){this.name=a;this.styles=b;this.scaleStyles=[]}GCISObjectType.prototype.getStyle=function(c){var a;
var b=this.scaleStyles[c];if(!b){for(a=0;a<this.styles.length;a++){b=this.styles[a];if(b.minScale<=c&&b.maxScale>=c){this.scaleStyles[c]=b;break}}}return b};function GCISObjectStyle(e,a,j,b,k,i,h,l,f,g,d,c){this.minScale=e;this.maxScale=a;this.icon=j;this.width=b;this.height=k;this.hotSpotX=i;this.hotSpotY=h;
this.bgColor=l;this.bgOpacity=f;this.borderColor=g;this.borderWidth=d;this.objnamecss=c}GCUI.Map=OpenLayers.Class(OpenLayers.Map,{EVENT_TYPES:["preaddlayer","addlayer","preremovelayer","removelayer","changelayer","movestart","move","moveend","zoomend","popupopen","popupclose","addmarker","removemarker","clearmarkers","mouseover","mouseout","mousemove","dragstart","drag","dragend","changebaselayer","load"],allOverlays:true,projection:"EPSG:27572",minLogicalScale:1,maxLogicalScale:12,numZoomLevels:12,initialize:function(b,a){if(a){if(a.x&&a.y&&!a.center){a.center=new OpenLayers.LonLat(a.x,a.y)
}a.theme=null;a.controls=a.controls||this.getDefaultControls();if(a.scale){a.zoom=this.numZoomLevels-a.scale}}OpenLayers.Map.prototype.initialize.apply(this,[b,a]);this.initBaseLayer(b,a)},getDefaultControls:function(){return[new GCUI.Control.Navigation()]},initBaseLayer:function(e,a){this.addToDocument(e);
if(!(this.server&&((this.mapName&&this.tab)||this.layer))){return}var c=null;if(this.limits){c={minX:this.limits[0],maxX:this.limits[1],minY:this.limits[2],maxY:this.limits[3]}}this.events.register("load",this,this.addDefaultHtcLayers);this.showSlider=this.showSlider||(a.showSlider===undefined);var d=this.ratios?this.ratios.split("~"):null;
var b=new GCUI.Layer.GeoConcept("main",this.server,{mapname:this.mapName,tabname:this.tab,layer:this.layer},OpenLayers.Util.extend({extension:this.format,layerVersion:(this.version?this.version:0),tileSize:new OpenLayers.Size(this.tilewidth||300,this.tileheight||300),precision:this.precision,ratios:d,extent:c,initMapInformations:true,eventListeners:this.ratios?null:{init:this.onBaseLayerLoaded,scope:this}},a.layerOptions));
if(this.ratios){this.onBaseLayerLoaded({object:b})}},onBaseLayerLoaded:function(c){var a=c.object;if(a.ratios&&a.extent){a.processMetadata({result:a})}this.maxLogicalScale=this.options.maxLogicalScale||a.resolutions.length;this.resolution=a.resolutions[this.maxLogicalScale-this.zoom-1];this.addLayer(a);
var b=this.getCenter();if(!b||(b.lon===0&&b.lat===0)){b=a.maxExtent.getCenterLonLat()}this.precision=a.metadata.precision;this.maxExtent=a.getMaxExtent();this.moveTo(b,this.zoom,{forceZoomChange:true});if(!this.initialized){this.initialized=true;this.events.triggerEvent("load")}},addToDocument:function(b){var a=this.document||document;
if(!a.maps){a.maps=[]}a.maps[b]=this},addDefaultHtcLayers:function(){this.objectLayer=new GCUI.Layer.Object();this.addLayer(this.objectLayer);this.objectLayer.resolutions=this.baseLayer.resolutions;var a=this.scale||this.getLogicalScale();this.setCenter(null,this.getNumZoomLevels()-a);this.setLayerIndex(this.objectLayer,this.layers.length);
if(this.showSlider){delete this.showSlider;this.addControl(new GCUI.Control.ScaleSlider())}},isValidZoomLevel:function(b){var a=this.getNumZoomLevels()-b;return((b!==null)&&(a>=this.minLogicalScale)&&(a<=this.maxLogicalScale))},getLogicalScale:function(){return(this.getNumZoomLevels()-this.zoom)},animateZoom:function(c){if(!c||(c<this.minLogicalScale)||(c>this.maxLogicalScale)||(c===this.getLogicalScale())){return
}var b=this.getSize();var a=new OpenLayers.Pixel(b.w/2,b.h/2);this.zoomTo(this.getNumZoomLevels()-c,a)},onEvent:function(b,a){this.events.register(b,this,a);if(b==="load"&&this.initialized){a()}},maximize:function(e,b){var j=this.document||document;var f=this.window||window;var g=j.documentElement;var c=g.clientWidth?g.clientWidth:j.body.clientWidth;
var k=(f.innerWidth?f.innerWidth:c);var a=g.clientHeight?g.clientHeight:j.body.clientHeight;var d=(f.innerHeight?f.innerHeight:a);var i=OpenLayers.Util.pagePosition(this.div);this.div.style.width=(k-i[0]-(e||0))+"px";this.div.style.height=(d-i[1]-(b||0))+"px";this.updateSize()},setMaxLogicalScale:function(b){this.maxLogicalScale=b;
var c=this.getControlsByClass("GCUI.Control.ScaleSlider");for(var a=0;a<c.length;a++){c[a].setMaximumScale(b)}if(this.baseLayer&&this.getLogicalScale()>b){this.zoomTo(this.getNumZoomLevels()-b)}},setMinLogicalScale:function(b){this.minLogicalScale=b;var c=this.getControlsByClass("GCUI.Control.ScaleSlider");
for(var a=0;a<c.length;a++){c[a].setMinimumScale(b)}if(this.baseLayer&&this.getLogicalScale()<b){this.zoomTo(this.getNumZoomLevels()-b)}},setSize:function(a,b){this.div.style.width=a;this.div.style.height=b;this.updateSize()},toJSON:function(m){var w='{ "context":{';var l=this.precision;var t=m?m:"png";
var c=this.getLonLatFromPixel(new OpenLayers.Pixel(0,0));var b=this.getLonLatFromPixel(new OpenLayers.Pixel(this.size.w,this.size.h));var a="[["+c.lon+","+b.lat+"],["+b.lon+","+c.lat+"]]";var y=this.getCenter();w+='"center":['+y.lon+","+y.lat;w+='],"size":['+this.size.w+","+this.size.h;w+='],"scale":'+this.getLogicalScale()+',"bbox": '+a;
w+=',"format": "'+t+'"';var u=this.getControlsByClass("GCUI.Control.GraphicScale");if(u&&u[0]){w+=',"graphicScale":'+u[0].toJSON()}w+='},"layers": [';var r;var e,q=1;for(r=0;r<this.layers.length;r++){e=this.layers[r];if(e.getVisibility()&&(e.CLASS_NAME==="GCUI.Layer.GeoConcept"||e.CLASS_NAME==="GCUI.Layer.Thematic")){t=e.extension;
if(t==="png"&&e.transparent){t="pngt"}var h=e.getMapName();if(h.indexOf(".gcm")===-1){h=h+".gcm"}var d=e.tabname||"";w+='{"order":'+q+',"type":"raster","raster":{"map":"'+h+'","tab":"'+d+'","format":"'+t+'","opacity":'+(e.opacity*100||100)+(e.userId?(',"userId":"'+e.userId+'"'):"")+"}},";q++}}w+='{"order":'+q+',"type":"vector","features": [';
var g=this.objectLayer.getVisibility()?this.objectLayer.toJSON():"";if(this.copyrightLayer){var x=this.copyrightLayer.toJSON();if(g!==""&&x!==""){g+=","}g+=x}w+=g;var n="";var v=0;for(r=0;r<this.layers.length;r++){e=this.layers[r];if(e.getVisibility()&&(e.CLASS_NAME==="OpenLayers.Layer.Vector"||e.CLASS_NAME==="GCUI.Layer.Vector")&&e.name.indexOf("OpenLayers.Handler.")===-1){var o;
var s=e.features.length;for(o=0;o<s;o++){var f=e.features[o];if(f.onScreen()){var k=GCUI.Util.getFeatureJSON(f,l,v);v++;n+=k;if(k!==""){n+=","}}}}}if(n!==""){n=(g!==""?",":"")+n.substring(0,n.length-1)}w+=n;return w+"]}]}"},moveTo:function(h,b,e){if(h!=null&&!(h instanceof OpenLayers.LonLat)){h=new OpenLayers.LonLat(h)
}if(!e){e={}}if(b!=null){b=parseFloat(b);if(!this.fractionalZoom){b=Math.round(b)}}var m=b;b=this.adjustZoom(b);if(b!==m){h=this.getCenter()}var p=e.dragging||this.dragging;var k=e.forceZoomChange;if(!this.getCachedCenter()&&!this.isValidLonLat(h)){h=this.maxExtent.getCenterLonLat();this.center=h.clone()
}if(this.restrictedExtent!=null){if(h==null){h=this.center}if(b==null){b=this.getZoom()}var q=this.getResolutionForZoom(b);var n=this.calculateBounds(h,q);if(!this.restrictedExtent.containsBounds(n)){var w=this.restrictedExtent.getCenterLonLat();if(n.getWidth()>this.restrictedExtent.getWidth()){h=new OpenLayers.LonLat(w.lon,h.lat)
}else{if(n.left<this.restrictedExtent.left){h=h.add(this.restrictedExtent.left-n.left,0)}else{if(n.right>this.restrictedExtent.right){h=h.add(this.restrictedExtent.right-n.right,0)}}}if(n.getHeight()>this.restrictedExtent.getHeight()){h=new OpenLayers.LonLat(h.lon,w.lat)}else{if(n.bottom<this.restrictedExtent.bottom){h=h.add(0,this.restrictedExtent.bottom-n.bottom)
}else{if(n.top>this.restrictedExtent.top){h=h.add(0,this.restrictedExtent.top-n.top)}}}}}var l=k||((this.isValidZoomLevel(b))&&(b!=this.getZoom()));var g=(this.isValidLonLat(h))&&(!h.equals(this.center));if(l||g||p){p||this.events.triggerEvent("movestart",{zoomChanged:l});if(g){if(!l&&this.center){this.centerLayerContainer(h)
}this.center=h.clone()}var x=l?this.getResolutionForZoom(b):this.getResolution();if(l||this.layerContainerOrigin==null){this.layerContainerOrigin=this.getCachedCenter();this.layerContainerOriginPx.x=0;this.layerContainerOriginPx.y=0;this.applyTransform();var o=this.getMaxExtent({restricted:true});var d=o.getCenterLonLat();
var j=this.center.lon-d.lon;var c=d.lat-this.center.lat;var u=o.getWidth()/x;var t=o.getHeight()/x;this.minPx={x:(this.size.w-u)/2-j/x,y:(this.size.h-t)/2-c/x};this.maxPx={x:this.minPx.x+u,y:this.minPx.y+t}}if(l){this.zoom=b;this.resolution=x}var f=this.getExtent();if(this.baseLayer.visibility&&this.baseLayer.opacity!==0){this.baseLayer.moveTo(f,l,e.dragging);
e.dragging||this.baseLayer.events.triggerEvent("moveend",{zoomChanged:l})}f=this.baseLayer.getExtent();for(var r=this.layers.length-1;r>=0;--r){var v=this.layers[r];if(v!==this.baseLayer&&!v.isBaseLayer){var a=v.calculateInRange();if(v.inRange!=a){v.inRange=a;if(!a){v.display(false)}this.events.triggerEvent("changelayer",{layer:v,property:"visibility"})
}if(a&&v.visibility&&v.opacity!==0){v.moveTo(f,l,e.dragging);e.dragging||v.events.triggerEvent("moveend",{zoomChanged:l})}}}this.events.triggerEvent("move");p||this.events.triggerEvent("moveend");if(l){for(var r=0,s=this.popups.length;r<s;r++){this.popups[r].updatePosition()}this.events.triggerEvent("zoomend")
}}},centerLayerContainer:function(c){var d=this.getViewPortPxFromLonLat(this.layerContainerOrigin);var g=this.getViewPortPxFromLonLat(c);if((d!=null)&&(g!=null)){var a=this.layerContainerOriginPx.x;var b=this.layerContainerOriginPx.y;var f=d.x-g.x;var e=d.y-g.y;this.applyTransform((this.layerContainerOriginPx.x=f),(this.layerContainerOriginPx.y=e));
var i=a-f;var h=b-e;this.minPx.x-=i;this.maxPx.x-=i;this.minPx.y-=h;this.maxPx.y-=h}},CLASS_NAME:"GCUI.Map"});GCUI.getMap=function(a,c){if(!c){c=document}if(!c.maps){return null}if(!a){for(var b in c.maps){if(c.maps.hasOwnProperty(b)){a=b;break}}}return c.maps[a]||null};GCUI.getUserId=function(c,b,e){var a=c.lastIndexOf("/map");
if(a===-1){a=c.lastIndexOf("/wmts")}c=c.substring(0,a);var d=new OpenLayers.Protocol.Script({url:c+"/htcservlet/gcis.js",callbackKey:"C"});if(b.indexOf(".gcm")===-1){b=b+".gcm"}d.createRequest(d.url,{M:b,V:"XgoUserID",T:new Date().getTime()},function(f){e(f.responseText)})};GCUI.Util=GCUI.Util||{};GCUI.Util.getFeatureJSON=function(m,u,p){var e=function(y,i,x){if(i&&typeof(i)==="string"){if(i.indexOf("${")===-1){if(i.length===0&&x){var C=OpenLayers.Feature.Vector.style["default"];
return C[x]}else{return i}}else{return y.attributes[i.substring(2,i.length-1)]}}else{return i?i:""}};if(!m.kind&&m.geometry){if(m.geometry instanceof OpenLayers.Geometry.LineString||m.geometry instanceof OpenLayers.Geometry.MultiLineString){m.kind="line"}if(m.geometry instanceof OpenLayers.Geometry.Polygon||m.geometry instanceof OpenLayers.Geometry.MultiPolygon){m.kind="poly"
}}var r;if(m.style){r=m.style}else{var s=m.layer.styleMap.styles["default"];if(s.rules.length>0){for(var B in s.rules[0].symbolizer){r=s.rules[0].symbolizer[B]}}else{r=s.defaultStyle}}var a=100*(r.strokeOpacity||1);if(m.kind==="circle"){return'{"type":"circle","center":['+GCUI.Util.getFeatureXpoints(m)[0]*u+","+GCUI.Util.getFeatureYpoints(m)[0]*u+'],"radius":'+GCUI.Util.getFeatureRadius(m)*u+',"lineColor":"'+e(m,r.strokeColor,"strokeColor")+'","lineWidth":'+e(m,r.strokeWidth,"strokeWidth")+',"opacity":'+a+',"order":'+p+',"fillColor":"'+e(m,r.fillColor,"fillColor")+'","fillOpacity":'+(100*r.fillOpacity)+"}"
}if(m.kind==="line"||m.kind==="poly"||m.kind==="rect"){var q,j,h;var w=[];var t=GCUI.Util.getFeatureXpoints(m);var A=GCUI.Util.getFeatureYpoints(m);var k=t.length;if(m.kind==="poly"&&k<3){return""}for(q=0;q<k;q++){j=t[q];h=A[q];w.push("[");w.push(j*u);w.push(",");w.push(h*u);w.push("]");if(q!==k-1){w.push(",")
}}w.push("],");var f='{ "type":"line","linestring":['+w.join("");var v="}";if(m.kind==="poly"||m.kind==="rect"){f='{"type":"polygon","polygon":"'+GCUI.Util.getFeatureWkt(m,true)+'",';v=',"fillColor":"'+e(m,r.fillColor,"fillColor")+'","fillOpacity":'+(100*r.fillOpacity)+"}"}return f+'"lineColor":"'+e(m,r.strokeColor,"strokeColor")+'","lineWidth":'+e(m,r.strokeWidth,"strokeWidth")+',"opacity":'+a+',"order":'+p+v
}else{var z=m.layer.map;w="";if(r&&r.externalGraphic){w='{"type":"point","center":[';if(z.objectLayer.getObjectXY(m.fid).length>0){var n=z.objectLayer.getObjectXY(m.fid);w+=n[0]*u+","+n[1]*u+"]";var g='{"text":"'+e(m,r.label)+'",';g+='"bgcol":"'+e(m,r.fontColor,"fontColor")+'",';g+='"color":"'+e(m,r.fontColor,"fontColor")+'",';
g+='"font":"'+e(m,r.fontFamily,"fontFamily")+'",';g+='"fontsize":"'+e(m,r.fontSize,"fontSize")+'",';g+='"hotspot":[0,0],"delta":['+(-r.labelXOffset)+","+(-r.labelYOffset)+"]}";w+=',"label":'+g}else{w+=m.geometry.x+","+m.geometry.y+"]"}var d=OpenLayers.Util.createUrlObject(r.externalGraphic);if(d.protocol==="http:"){d=d.protocol+"//"+d.host+":"+d.port+d.pathname+"?"+OpenLayers.Util.getParameterString(d.args)
}w+=',"style":{"type":"image","url":"'+d+'",';w+='"pointRadius":"'+e(m,r.pointRadius,"pointRadius")+'"';w+="}";if(r.graphicXOffset!=undefined&&r.graphicYOffset!=undefined){w+=',"hotspot":['+(-r.graphicXOffset)+","+(-r.graphicYOffset)+"]"}else{if(r.graphicWidth&&r.graphicHeight){w+=',"hotspot":['+(r.graphicWidth/2)+","+(r.graphicHeight/2)+"]"
}}w+=',"order":'+p+"}"}else{var s=OpenLayers.Feature.Vector.style["default"];var o="";var l=e(m,r.graphicName,"graphicName");var c="circle";if(l){c="polygon";var b=OpenLayers.Renderer.symbol[l];o="";for(var q=0;q<b.length;q=q+2){o+="[["+b[q]+","+b[q+1]+"]]"}}w='{"type":"point","center":[';w+=m.geometry.x+","+m.geometry.y+"],";
if(r.label){w+='"label":';w+='{"text":"'+encodeURIComponent(e(m,r.label))+'",';w+='"bgcol":"'+e(m,r.fontColor,"fontColor")+'",';w+='"color":"'+e(m,r.fontColor,"fontColor")+'",';w+='"font":"'+e(m,r.fontFamily,"fontFamily")+'",';w+='"fontsize":"'+e(m,r.fontSize,"fontSize")+'",';w+='"hotspot":[0,0], "delta":[0,0]},'
}w+='"style":{"type":"'+c+'",';if(r.label){w+='"opacity":0,'}w+='"fillColor":"'+e(m,r.fillColor,"fillColor")+'",';w+='"lineColor":"'+e(m,r.strokeColor,"strokeColor")+'",';w+='"lineWidth":"'+e(m,r.strokeWidth,"strokeWidth")+'",';w+='"opacity":"'+e(m,r.fillOpacity,"opacity")*100+'",';if(c==="circle"){w+='"pointRadius":"'+e(m,r.pointRadius,"pointRadius")+'"'
}else{w+='"polygon":'+o}w+="},";w+='"order":'+p+"}"}return w}};GCUI.Util.getFeatureXpoints=function(f,g){var b=[];var c=g?1:f.layer.map.precision;if(f.kind==="circle"){b.push(f.geometry.getBounds().getCenterLonLat().lon/c)}else{var d=f.geometry.getVertices();for(var e=0,a=d.length;e<a;e++){b.push(d[e].x/c)
}if(f.kind==="poly"&&b.length>0){b.push(b[0])}}if(f.kind==="rect"){b[1]=b[0];b[3]=b[2];b[4]=b[0]}return b};GCUI.Util.getFeatureYpoints=function(f,g){var b=[];var c=g?1:f.layer.map.precision;if(f.kind==="circle"){b.push(f.geometry.getBounds().getCenterLonLat().lat/c)}else{var d=f.geometry.getVertices();
for(var e=0,a=d.length;e<a;e++){b.push(d[e].y/c)}if(f.kind==="poly"&&b.length>0){b.push(b[0])}}if(f.kind==="rect"){b[1]=b[2];b[3]=b[0];b[4]=b[0]}return b};GCUI.Util.getFeatureRadius=function(c,d){var b=c.geometry.getBounds();var a=d?1:c.layer.map.precision;return b.getWidth()/(2*a)};GCUI.Util.getFeatureWkt=function(e,b){if(!b){b=e.layer.map.precision;
e=e.clone();var c=e.geometry.getVertices();for(var d=0,a=c.length;d<a;d++){c[d].x=c[d].x/b;c[d].y=c[d].y/b}}return(new OpenLayers.Format.WKT()).write(e)};GCUI.Console=GCUI.Console||{};GCUI.Console.error=function(b){try{if(window.console&&console.error){console.error(b)}}catch(a){}};OpenLayers.Util.extend(OpenLayers.Console,GCUI.Console);
GCUI.Control=GCUI.Control||{};GCUI.Control.Navigation=OpenLayers.Class(OpenLayers.Control.Navigation,{centerOnWheelEvent:false,mouseWheelOptions:{interval:50},defaultDblClick:function(b){var a=this.map.getLonLatFromViewPortPx(b.xy);this.map.panTo(a)},wheelChange:function(a,f){var e=this.map.getZoom();
f=(f>0)?1:-1;var d=this.map.getZoom()+Math.round(f);d=Math.max(d,this.map.getNumZoomLevels()-this.map.maxLogicalScale);d=Math.min(d,this.map.getNumZoomLevels()-this.map.minLogicalScale);if(d===e){return}var c=a.xy;if(!this.centerOnWheelEvent){var b=this.map.getSize();c=new OpenLayers.Pixel(b.w/2,b.h/2)
}this.map.zoomTo(d,c)},CLASS_NAME:"GCUI.Control.Navigation"});GCUI.Control.GraphicScale=OpenLayers.Class(OpenLayers.Control,{METRICSUIMETER:[1000,1,0.01,0.001],METRICSUISYMBOL:["km","m","cm","mm"],barAreaWidth:150,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a]);this.isOnTheMap=this.div?false:true;
this.initialx=this.posx;this.initialy=this.posy},updatePosition:function(){if(this.isOnTheMap){if(this.initialx<0){this.posx=this.map.size.w+this.initialx-parseInt(this.scaleDiv.clientWidth,10)-1}if(this.initialy<0){this.posy=this.map.size.h+this.initialy-parseInt(this.scaleDiv.clientHeight,10)-1}this.div.style.left=this.posx+"px";
this.div.style.top=this.posy+"px"}},draw:function(){OpenLayers.Control.prototype.draw.apply(this,[]);this.scaleDiv=document.createElement("div");OpenLayers.Element.addClass(this.scaleDiv,"mapScale");this.div.appendChild(this.scaleDiv);this.divLegend=document.createElement("div");this.divLegend.className="mapScaleLegend";
this.scaleDiv.appendChild(this.divLegend);this.divText1=document.createElement("div");this.divText1.className="mapScaleText1";this.scaleDiv.appendChild(this.divText1);this.divText2=document.createElement("div");this.divText2.className="mapScaleText2";this.scaleDiv.appendChild(this.divText2);this.text1=document.createTextNode("0");
this.divText1.appendChild(this.text1);this.text2=document.createTextNode("0");this.divText2.appendChild(this.text2);this.map.events.register("zoomend",this,this.update);this.update();return this.div},computeBarMetrics:function(){var e=false;var f,g,a;var c=this.map.getResolution();for(var d=0;d<4&&!e;
d++){f=100000;g=this.METRICSUIMETER[d];while((Math.round(f)>0)&&!e){a=(f*g)/c;if(a<this.barAreaWidth){e=true;this.unitInfo=this.METRICSUIMETER[d];this.uiSymbol=this.METRICSUISYMBOL[d];this.width=a;this.distance=f}else{f/=10}}}var b=1;while(b<5){if((this.width*(b+1))<this.barAreaWidth){b++}else{break}}this.divisionCount=b;
this.width*=b;this.distance*=b;this.divText2.innerHTML=this.distance+" "+this.uiSymbol;this.divText2.style.left=this.width+"px"},update:function(){if(this.map&&this.map.baseLayer){this.computeBarMetrics();var b;var a=this.divLegend.childNodes.length;if(this.divLegend){for(b=0;b<a;b++){this.divLegend.removeChild(this.divLegend.childNodes[0])
}}this.drawBar()}},drawBar:function(){if(this.divLegend){this.scaleDiv.removeChild(this.divLegend)}this.divLegend=document.createElement("div");this.divLegend.className="mapScaleLegend";this.divLegend.style.width=this.width+"px";this.scaleDiv.style.width=(this.width+this.divText2.clientWidth)+"px";this.updatePosition();
this.scaleDiv.appendChild(this.divLegend);if(this.divisionCount===1){this.divisionCount=5}var b,a;for(a=0;a<this.divisionCount;a++){b=document.createElement("div");b.style.width=this.width/this.divisionCount+"px";b.style.left=a*(this.width/this.divisionCount)+"px";b.className=((a%2)===0)?"mapScaleFullBlock":"mapScaleEmptyBlock";
this.divLegend.appendChild(b)}},toJSON:function(){var a=this.initialy<0?"bottom":"top";var b=this.initialx<0?"right":"left";var c=this.map.mapName;if(c.indexOf(".gcm")===-1){c=c+".gcm"}return'{"map":"'+c+'","valign":"'+a+'","halign":"'+b+'","hoffset":'+Math.abs(this.initialx)+',"voffset":'+Math.abs(this.initialy)+',"barsize":[5,150]}'
},CLASS_NAME:"GCUI.Control.GraphicScale"});var GCUI=GCUI||{};GCUI.Slider=OpenLayers.Class({initialize:function(d,a,c,b,e){this.handle=d;this.track=a;this.axis=c||"horizontal";this.handle.className=(b?b:"")+"handle_"+this.axis;this.track.className=(b?b:"")+"track_"+this.axis;this.range={start:0,end:100};
this.value=0;this.maximum=this.range.end;this.minimum=this.range.start;this.alignX=0;this.alignY=0;this.setTrackAndHandleLength();this.map=e;this.eventMouseDown=OpenLayers.Function.bindAsEventListener(this.startDrag,this);this.eventMouseUp=OpenLayers.Function.bindAsEventListener(this.endDrag,this);this.eventMouseMove=OpenLayers.Function.bindAsEventListener(this.update,this);
this.setValue(parseFloat(this.range.start),0);this.handle.style.position="relative";OpenLayers.Event.observe(this.handle,"mousedown",this.eventMouseDown);OpenLayers.Event.observe(this.track,"mousedown",this.eventMouseDown)},setTrackAndHandleLength:function(){this.trackLength=this.maximumOffset()-this.minimumOffset();
this.handleLength=this.isVertical()?this.handle.offsetHeight:this.handle.offsetWidth},setMinimum:function(a){this.range.start=a;this.minimum=this.range.start;if(a>this.value){this.setValue(a)}if(a>this.range.end){this.setMaximum(a)}},setMaximum:function(a){this.range.end=a;this.maximum=this.range.end;
if(a<this.value){this.setValue(a)}if(a<this.range.start){this.setMinimum(a)}},getValue:function(){return parseInt(this.value,10)},getNearestValue:function(a){if(a>this.range.end){return this.range.end}if(a<this.range.start){return this.range.start}return a},setValue:function(b,a){if(!this.active){this.activeHandle=this.handle;
this.activeHandleIdx=a;this.updateStyles()}a=a||this.activeHandleIdx||0;b=this.getNearestValue(b);this.value=b;this.handle.style[this.isVertical()?"top":"left"]=this.translateToPx(b);this.drawSpans();if(!this.dragging||!this.event){this.updateFinished()}},translateToPx:function(b){var a=Math.round(((this.trackLength-this.handleLength)/(this.range.end-this.range.start))*(b-this.range.start));
if(isNaN(a)){a=0}return a+"px"},translateToValue:function(a){return((a/(this.trackLength-this.handleLength)*(this.range.end-this.range.start))+this.range.start)},minimumOffset:function(){return(this.isVertical()?this.alignY:this.alignX)},maximumOffset:function(){return(this.isVertical()?this.track.offsetHeight-this.alignY:this.track.offsetWidth-this.alignX)
},isVertical:function(){return(this.axis==="vertical")},drawSpans:function(){},updateStyles:function(){},startDrag:function(b){var c,d,a;if(OpenLayers.Event.isLeftClick(b)){if(!this.trackLength&&!this.handleLength){this.setTrackAndHandleLength()}OpenLayers.Event.observe(this.track.parentNode,"mouseup",this.eventMouseUp);
OpenLayers.Event.observe(document,"mouseup",this.eventMouseUp);if(this.map){this.map.events.on({mouseup:this.eventMouseUp})}OpenLayers.Event.observe(this.track.parentNode,"mousemove",this.eventMouseMove);this.active=true;c=OpenLayers.Event.element(b);d=[this.pointerX(b),this.pointerY(b)];if(c==this.track){a=this.cumulativeOffset(this.track);
this.event=b;this.setValue(this.translateToValue((this.isVertical()?d[1]-a[1]:d[0]-a[0])-(this.handleLength/2)));a=this.cumulativeOffset(this.activeHandle);this.offsetX=(d[0]-a[0]);this.offsetY=(d[1]-a[1])}else{this.activeHandle=c;this.activeHandleIdx=0;this.updateStyles();a=this.cumulativeOffset(this.activeHandle);
this.offsetX=(d[0]-a[0]);this.offsetY=(d[1]-a[1])}OpenLayers.Event.stop(b)}},update:function(a){if(this.active){if(!this.dragging){this.dragging=true}this.draw(a);if(navigator.appVersion.indexOf("AppleWebKit")>0){window.scrollBy(0,0)}OpenLayers.Event.stop(a)}},draw:function(b){var c=[this.pointerX(b),this.pointerY(b)];
var a=this.cumulativeOffset(this.track);c[0]-=this.offsetX+a[0];c[1]-=this.offsetY+a[1];this.event=b;this.setValue(this.translateToValue(this.isVertical()?c[1]:c[0]))},endDrag:function(a){if(this.active&&this.dragging){this.finishDrag(a,true);OpenLayers.Event.stop(a)}this.active=false;this.dragging=false;
if(typeof this.onrelease==="function"){this.onrelease()}OpenLayers.Event.stopObserving(this.track.parentNode,"mouseup",this.eventMouseUp);OpenLayers.Event.stopObserving(document,"mouseup",this.eventMouseUp);if(this.map){this.map.events.un({mouseup:this.eventMouseUp})}OpenLayers.Event.stopObserving(this.track.parentNode,"mousemove",this.eventMouseMove)
},finishDrag:function(a,b){this.active=false;this.dragging=false;this.updateFinished()},updateFinished:function(){if(this.onChange){this.onChange(this.getValue(),this)}this.event=null},cumulativeOffset:function(b){var a=0,c=0;if(/Konqueror|Safari|KHTML/.test(navigator.userAgent)){do{a+=b.offsetTop||0;
c+=b.offsetLeft||0;if(b.offsetParent==document.body&&b.style.position==="absolute"){break}b=b.offsetParent}while(b)}else{do{a+=b.offsetTop||0;c+=b.offsetLeft||0;b=b.offsetParent}while(b)}return[c,a]},pointerX:function(c){var b=document.documentElement,a=document.body||{scrollLeft:0};return c.pageX||(c.clientX+(b.scrollLeft||a.scrollLeft)-(b.clientLeft||0))
},pointerY:function(c){var b=document.documentElement,a=document.body||{scrollTop:0};return c.pageY||(c.clientY+(b.scrollTop||a.scrollTop)-(b.clientTop||0))}});GCUI=GCUI||{};GCUI.Control=GCUI.Control||OpenLayers.Control;GCUI.Control.ScaleSlider=OpenLayers.Class(OpenLayers.Control,{autoActivate:true,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a]);
this.inverseDir=this.inverseDir||false;this.orientation=this.orientation||"vertical";this.isOnTheMap=true},activate:function(){this.slider=new GCUI.Slider(this.sliderHandle,this.sliderTrack,this.orientation,"",this.map);this.setMinimumScale(this.map.minLogicalScale);this.setMaximumScale(this.map.maxLogicalScale);
this.setScale(this.map.getNumZoomLevels()-this.map.zoom);this.slider.onrelease=OpenLayers.Function.bindAsEventListener(this.onrelease,this);return OpenLayers.Control.prototype.activate.apply(this,[])},destroy:function(){this.map.events.un({zoomend:this.setScale,scope:this});this.slider.onrelease=null;
OpenLayers.Control.prototype.destroy.apply(this,[])},draw:function(a){OpenLayers.Control.prototype.draw.apply(this,[a]);this.div.className="mapslider";this.div.id=this.map.div.id+"_slider";var b=document.createElement("div");this.div.appendChild(b);var c=document.createElement("div");b.appendChild(c);
this.createZoomButton("mapsliderZoomIn",-1);this.createZoomButton("mapsliderZoomOut",1);this.sliderTrack=b;this.sliderHandle=c;this.map.events.register("zoomend",this,this.setScale);return this.div},createZoomButton:function(a,c){var b=document.createElement("div");b.className=a;b.onclick=OpenLayers.Function.bindAsEventListener(this.zoom,{slider:this,delta:c});
this.div.appendChild(b)},zoom:function(a){this.slider.map.animateZoom(this.slider.map.getNumZoomLevels()-this.slider.map.getZoom()+this.delta);OpenLayers.Event.stop(a)},onrelease:function(){this.map.animateZoom(this.map.getNumZoomLevels()-this.getScale())},setScale:function(a){if(a.object){a=a.object.getNumZoomLevels()-a.object.zoom
}if(!this.slider){return}this.slider.setValue(this.transformValue(a))},getScale:function(){return this.inverseDir?this.slider.getValue():this.map.getNumZoomLevels()-this.slider.getValue()},transformValue:function(a){if(this.inverseDir){return(this.maximum-a)+this.minimum}else{return a}},setMinimumScale:function(a){this.minimum=a;
if(this.slider){this.slider.setMinimum(a)}},setMaximumScale:function(a){this.maximum=a;if(this.slider){this.slider.setMaximum(a)}},CLASS_NAME:"GCUI.Control.ScaleSlider"});GCUI.Control.LayerSwitcher=OpenLayers.Class(OpenLayers.Control,{layerStates:null,layersDiv:null,minimizeDiv:null,maximizeDiv:null,ascending:false,opacityClass:"mapLayerSlider",maxLength:null,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a]);
this.layerStates=[]},destroy:function(){OpenLayers.Event.stopObservingElement(this.div);this.clear();this.map.events.un({addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this});OpenLayers.Control.prototype.destroy.apply(this,[])},clear:function(){this.clearLayersArray("data");
for(var a in this.groups){if(this.groups.hasOwnProperty(a)){if(this[a+"Div"]){OpenLayers.Event.stopObservingElement(this[a+"Div"])}if(this[a+"LayersDiv"]){this[a+"LayersDiv"].innerHTML="";delete this[a+"LayersDiv"]}}}this.layersDiv.innerHTML=""},setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,[a]);
this.map.events.on({addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this})},draw:function(){OpenLayers.Control.prototype.draw.apply(this);this.div.className="mapLayerControl";this.loadContents();this.redraw();return this.div},clearLayersArray:function(d){var e=this[d+"Layers"];
if(e){for(var c=0,a=e.length;c<a;c++){var b=e[c];OpenLayers.Event.stopObservingElement(b.inputElem);OpenLayers.Event.stopObservingElement(b.labelSpan);OpenLayers.Event.stopObservingElement(b.upSpan);OpenLayers.Event.stopObservingElement(b.downSpan)}}this[d+"Layers"]=[]},checkRedraw:function(){var e=false;
if(!this.layerStates.length||(this.map.layers.length!=this.layerStates.length)){e=true}else{for(var c=0,a=this.layerStates.length;c<a;c++){var d=this.layerStates[c];var b=this.map.layers[c];if((d.name!=b.name)||(d.inRange!=b.inRange)||(d.id!=b.id)||(d.visibility!=b.visibility)){e=true;break}}}return e
},redraw:function(b){if(b&&b.property=="opacity"&&b.layer.slider){b.layer.slider.setValue(b.layer.opacity*100)}if(!(b&&b.force)&&!this.checkRedraw()){return this.div}this.clear();if(b&&b.json){return}var a=this.map.layers.length;this.layerStates=[];for(var e=0;e<a;e++){var d=this.map.layers[e];this.layerStates[e]={name:d.name,visibility:d.visibility,inRange:d.inRange,id:d.id}
}var f=this.map.layers.slice();if(!this.ascending){f.reverse()}for(e=0;e<a;e++){var d=f[e];if(d.displayInLayerSwitcher){this.createLayerDiv(d)}}if(this.groups){for(var c in this.groups){if(!this.groups[c].expanded&&this[c+"Div"]){this.groupClick(c,this[c+"Div"].firstChild)}}}this.events.triggerEvent("layerSwitcherDrawComplete");
return this.div},addClass:function(b,a){if(a){OpenLayers.Element.addClass(b,a)}},createOpacitySlider:function(a,b){var f=document.createElement("div");this.addClass(f,this.opacityClass);var e=document.createElement("div");e.id="divTrack"+b.id;f.appendChild(e);var d=document.createElement("div");d.id="divHandle"+b.id;
e.appendChild(d);if(b.getVisibility()){a.appendChild(f)}var c=new GCUI.Slider(d,e,"horizontal","layer",b.map);c.setValue(b.opacity*100);f.title=c.getValue()+"%";c.drawSpans=OpenLayers.Function.bind(this.updateOpacityControl,this,c,b,f);b.slider=c},updateOpacityControl:function(b,a,c){c.title=b.getValue()+"%";
a.setOpacity(b.getValue()/100)},onUpClick:function(c){var b=this.layer.map;var a=b.getLayerIndex(this.layer);var d=1;if(!this.layer.group&&b.layers[a+1]&&b.layers[a+1].group){d=this.switcher.groups[b.layers[a+1].group].size}b.setLayerIndex(this.layer,a+d);OpenLayers.Event.stop(c)},onDownClick:function(c){var b=this.layer.map;
var a=b.getLayerIndex(this.layer);var d=1;if(!this.layer.group&&b.layers[a-1]&&b.layers[a-1].group){d=this.switcher.groups[b.layers[a-1].group].size}b.setLayerIndex(this.layer,a-d);OpenLayers.Event.stop(c)},onInputClick:function(c){var b=this.layer.visibility;var a=!b;if(this.inputElem){this.inputElem.className=(b?"mapLayerUnCheckbox":"mapLayerCheckbox")+(this.layer.group?"":" mapLayerLeft")
}else{if(this.checkElem){this.checkElem.checked=a?"checked":""}}this.layer.setVisibility(a);OpenLayers.Event.stop(c)},maximizeControl:function(a){this.div.style.width="";this.div.style.height="";this.showControls(false);this.ignoreEvent(a)},minimizeControl:function(a){this.div.style.width="0px";this.div.style.height="0px";
this.showControls(true);this.ignoreEvent(a)},showControls:function(a){this.layersDiv.style.display=a?"none":""},loadContents:function(){OpenLayers.Event.observe(this.div,"mouseup",OpenLayers.Function.bindAsEventListener(this.mouseUp,this));OpenLayers.Event.observe(this.div,"click",this.ignoreEvent);OpenLayers.Event.observe(this.div,"mousedown",OpenLayers.Function.bindAsEventListener(this.mouseDown,this));
OpenLayers.Event.observe(this.div,"dblclick",this.ignoreEvent);this.layersDiv=document.createElement("div");this.layersDiv.id=this.id+"_layersDiv";OpenLayers.Element.addClass(this.layersDiv,"layersDiv");this.div.appendChild(this.layersDiv)},ignoreEvent:function(a){if(a!=null){OpenLayers.Event.stop(a)
}},mouseDown:function(a){this.isMouseDown=true;this.ignoreEvent(a)},mouseUp:function(a){if(this.isMouseDown){this.isMouseDown=false;this.ignoreEvent(a)}},groupClick:function(d,a){var c=this[d+"LayersDiv"];if(c){var b=(c.style.display=="block");c.style.display=b?"none":"block";if(a&&a.className.indexOf("mapGroup")!==-1){a.className="mapGroup"+(b?"Plus":"Minus")
}this.groups[d].expanded=!b}this.events.triggerEvent("updateLayerSwitcherGroup")},createGroup:function(e){if(!this[e+"LayersDiv"]){var c=document.createElement("div");c.className="mapGroupInfo";var b=document.createElement("div");b.className="mapGroupMinus";c.appendChild(b);var a=document.createElement("div");
a.innerHTML=e;a.className="mapGroupName";c.appendChild(a);var d=document.createElement("div");d.style.display="block";this.layersDiv.appendChild(c);this.layersDiv.appendChild(d);this[e+"LayersDiv"]=d;OpenLayers.Event.observe(c,"click",OpenLayers.Function.bind(this.groupClick,this,e,b));this[e+"Div"]=c
}return this[e+"LayersDiv"]},getLayerLabel:function(d){var e=d.label||((d.name=="main")?(d.layer||d.tabname):d.name),c=e,a,b;if(this.maxLength){a=this.maxLength;b=a-4}else{a=GCUI.Control.LayerSwitcher.LAYER_LABEL_MAXLENGTH;b=GCUI.Control.LayerSwitcher.LAYER_LABEL_REPLACEMENT_INDEX}if(c.length>=a){c=c.substring(0,b)+GCUI.Control.LayerSwitcher.LAYER_LABEL_SUFFIX_REPLACEMENT
}return{title:e,label:c}},createLayerDiv:function(f){var l=document.createElement("div");l.className="mapLayerInfo";if(f.group){var g=document.createElement("div");g.className="mapLayerNode";l.appendChild(g)}var h=document.createElement("div");h.className=(f.getVisibility()?"mapLayerCheckbox":"mapLayerUncheckbox")+(f.group?"":" mapLayerLeft");
l.appendChild(h);var a={inputElem:h,layer:f,switcher:this};OpenLayers.Event.observe(h,"mouseup",OpenLayers.Function.bindAsEventListener(this.onInputClick,a));var b=document.createElement("div");OpenLayers.Element.addClass(b,"mapLayerName"+(f.depth?"":" mapLayerLeft"));var i=this.getLayerLabel(f);b.innerHTML=i.label;
b.title=i.title;OpenLayers.Event.observe(b,"click",OpenLayers.Function.bindAsEventListener(this.onInputClick,a));l.appendChild(b);var j=f.group?this.map.getLayersBy("group",f.group):this.map.getLayersBy("displayInLayerSwitcher",true);var e=OpenLayers.Util.indexOf(j,f);var c=document.createElement("div");
c.className="mapLayerUp";l.appendChild(c);OpenLayers.Event.observe(c,"click",OpenLayers.Function.bindAsEventListener(this.onUpClick,a));c.style.display=(e==j.length-1)?"none":"block";var d=document.createElement("div");d.className="mapLayerDown";l.appendChild(d);OpenLayers.Event.observe(d,"click",OpenLayers.Function.bindAsEventListener(this.onDownClick,a));
d.style.display=(e==0)?"none":"block";this.dataLayers.push({inputElem:h,labelSpan:b,upSpan:c,downSpan:d});var k=f.group?this.createGroup(f.group):this.layersDiv;k.appendChild(l);this.createOpacitySlider(l,f)},getGroupsFromJson:function(d){var f=d.layers;var e=null;this.groups=[];for(var c=0,a=f.length;
c<a;c++){var b=f[c];if(b.depth===0){if(b.expanded!==undefined){e=b.label||b.name;this.groups[e]={expanded:b.expanded,size:0}}}else{b.group=e;this.groups[e].size++}}},initFromJson:function(j){var k=this.map.baseLayer.url;var c=this.map.baseLayer.mapname;this.map.baseLayer.setVisibility(false);this.map.baseLayer.displayInLayerSwitcher=false;
for(var f=0;f<this.map.layers.length;f++){var g=this.map.layers[f];if(g.displayInLayerSwitcher&&this.map.baseLayer!=g){this.map.removeLayer(g)}}var d=j.layers;this.getGroupsFromJson(j);d=d.reverse();for(var f=0,h=d.length;f<h;f++){var g=d[f];var e;if(g.depth||(g.depth===0&&g.expanded===undefined)){if(g.type==="vector"){if(GCUI.Layer.Vector){e=new GCUI.Layer.Vector(g.label,{opacity:g.opacity/100,visibility:g.visibility,layerId:g.layerId,server:this.getServerUrl(),legend:g.legend,legendName:g.name,group:g.group,depth:g.depth})
}}else{var b=g.server||k;var a=g.mapname||c;e=new GCUI.Layer.GeoConcept(g.name,b,{mapname:a,tabname:g.internalName,layer:g.name,extension:g.format,singleTile:g.singleTiledLayer},{isBaseLayer:false,visibility:g.visibility,legend:g.legend,legendName:g.name,group:g.group,depth:g.depth,opacity:g.opacity/100,label:g.label,transparent:g.isTransparent||g.transparent})
}this.map.addLayer(e)}}},getServerUrl:function(){var b=this.map.baseLayer.url;var a=b.lastIndexOf("/map")!==-1?b.lastIndexOf("/map"):b.lastIndexOf("/wmts");return b.substring(0,a)},getLayersJson:function(a){var b=new OpenLayers.Protocol.Script({url:this.getServerUrl()+"/HtcLayer/showJson.do",params:{type:"layers",name:a,T:new Date().getTime()},format:new OpenLayers.Format(),handleResponse:function(d,c){this.destroyRequest(d.priv);
if(d.data){c.callback.call(c.scope,d.data)}else{GCUI.Console.error("LayerSwitcher. No JSON for "+a)}},callback:function(c){this.initFromJson(c)},scope:this});b.read()},CLASS_NAME:"GCUI.Control.LayerSwitcher"});GCUI.Control.LayerSwitcher.LAYER_LABEL_MAXLENGTH=18;GCUI.Control.LayerSwitcher.LAYER_LABEL_REPLACEMENT_INDEX=14;
GCUI.Control.LayerSwitcher.LAYER_LABEL_SUFFIX_REPLACEMENT="...";GCUI.Control.LayerSwitcher2=OpenLayers.Class(GCUI.Control.LayerSwitcher,{layersClass:"ui list",itemClass:"item",listClass:"list",checkboxClass:"ui checkbox right floated",opacityClass:"mapLayerSlider2",groupClass:"header",displayOpacitySlider:true,loadContents:function(){GCUI.Control.LayerSwitcher.prototype.loadContents.apply(this);
if(this.layersClass){OpenLayers.Element.addClass(this.layersDiv,this.layersClass)}},addListClass:function(a){this.addClass(a,this.listClass)},createGroup:function(e){var b=e+"LayersDiv";if(!this[b]){var c=document.createElement("div");this.addClass(c,this.itemClass);var a=document.createElement("div");
a.innerHTML=e;this.addClass(a,this.groupClass);c.appendChild(a);var d=document.createElement("div");this.addListClass(d);d.style.display="block";c.appendChild(d);this[b]=d;this[e+"Div"]=c;this.layersDiv.appendChild(c);OpenLayers.Event.observe(a,"click",OpenLayers.Function.bind(this.groupClick,this,e,null))
}return this[b]},createLayerDiv:function(g){var b=document.createElement("div");this.addClass(b,"mapLayerDiv "+this.itemClass);var e=this.getLayerLabel(g);var h=document.createElement("label");h.innerHTML=e.label;h.title=e.title;b.appendChild(h);var c=document.createElement("div");this.addClass(c,this.checkboxClass+" mapLayerCheckbox2");
var a=document.createElement("input");a.type="checkbox";a.checked=g.getVisibility()?"checked":"";c.appendChild(a);b.appendChild(c);var f={checkElem:c,layer:g,switcher:this};OpenLayers.Event.observe(c,"click",OpenLayers.Function.bindAsEventListener(this.onInputClick,f));var d=g.group?this.createGroup(g.group):this.layersDiv;
d.appendChild(b);if(this.displayOpacitySlider){this.createOpacitySlider(b,g)}},getLayerLabel:function(d){var e=d.label||((d.name=="main")?(d.layer||d.tabname):d.name),c=e,a,b;if(this.maxLength){a=this.maxLength;b=a-4}else{a=GCUI.Control.LayerSwitcher.LAYER_LABEL_MAXLENGTH;b=GCUI.Control.LayerSwitcher.LAYER_LABEL_REPLACEMENT_INDEX
}if(c.length>=a){c=c.substring(0,b)+GCUI.Control.LayerSwitcher.LAYER_LABEL_SUFFIX_REPLACEMENT}return{title:e,label:c}},CLASS_NAME:"GCUI.Control.LayerSwitcher2"});GCUI.Control.Popup=OpenLayers.Class(OpenLayers.Control,{positionBlocks:{tl:{left:true,top:true},tr:{left:false,top:true},bl:{left:true,top:false},br:{left:false,top:false}},initialize:function(b,a,d,c){this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_");
this.lonlat=b;this.contentHTML=a},destroy:function(){this.map.events.un({move:this.updatePosition,scope:this});OpenLayers.Control.prototype.destroy.apply(this,[])},draw:function(a){this.div=document.createElement("div");this.div.style.width="";this.div.style.height="";this.div.style.visibility="visible";
this.div.className="mapsheet";this.events=new OpenLayers.Events(this,this.div,null,true);this.events.on({click:this.onclick,mousedown:this.onmousedown,mousemove:this.onmousemove,mouseup:this.onmouseup,mouseout:this.onmouseout,touchstart:this.onTouchstart,scope:this});if(a==null&&(this.lonlat!=null)&&(this.map!=null)){a=this.map.getViewPortPxFromLayerPx(this.map.getLayerPxFromLonLat(this.lonlat))
}this.moveTo(a);this.setContentHTML();this.relativePosition=this.calculateRelativePosition(a);this.isUpdateRelativePosition=false;this.map.events.register("move",this,this.updatePosition);return this.div},calculateRelativePosition:function(b){var d=this.map.getLonLatFromLayerPx(b);var c=this.map.getExtent();
var a=c.determineQuadrant(d);return OpenLayers.Bounds.oppositeQuadrant(a)},onclick:function(a){var b=a.target||a.srcElement;if(b.tagName!="IMG"&&b.tagName!="A"){this.destroy()}OpenLayers.Event.stop(a,true)},updateRelativePosition:function(){this.isUpdateRelativePosition=true;if(this.relativePosition){var b=this.positionBlocks[this.relativePosition];
var d=b.left;var f=b.top;var c=this.div.offsetWidth;var g=this.div.offsetHeight;if(this.div.style.width==""){this.div.style.width=c+"px"}var i=parseInt(this.div.style.left);var a=parseInt(this.div.style.top);var e=new OpenLayers.Pixel(d?(i-c):i,f?(a-g):a);this.moveTo(e)}},updatePosition:function(){if((this.lonlat)&&(this.map)){var a=this.map.getViewPortPxFromLayerPx(this.map.getLayerPxFromLonLat(this.lonlat));
if(a){this.moveTo(a);if(this.contentHTML!=""&&this.isUpdateRelativePosition){this.updateRelativePosition(a)}}}},setContentHTML:function(a){if(a!=null){this.contentHTML=a}if((this.div!=null)&&(this.contentHTML!=null)&&(this.contentHTML!=this.div.innerHTML)){this.div.innerHTML="<div>"+this.contentHTML+"</div>"
}},onmousedown:function(a){this.mousedown=true;OpenLayers.Event.stop(a,true)},onmousemove:function(a){if(this.mousedown){OpenLayers.Event.stop(a,true)}},onmouseup:function(a){if(this.mousedown){this.mousedown=false;OpenLayers.Event.stop(a,true)}},onmouseout:function(a){this.mousedown=false},onTouchstart:function(a){OpenLayers.Event.stop(a,true)
},CLASS_NAME:"GCUI.Control.Popup"});GCUI.Control.GlobalView=OpenLayers.Class(OpenLayers.Control,{initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a]);this.initialx=this.posx;this.initialy=this.posy;this.initialw=this.width;this.initialh=this.height;this.visible=true;if(this.format!=="png"&&this.format!=="jpg"&&this.format!=="png24"){this.format="png"
}this.zooms=[];this.scales=[];this.crossWidth=10;this.crossHeight=10;this.crossLineWidth=2;this.defaultImg=OpenLayers.Util.getImagesLocation()+"blank.gif";this.handlers={}},draw:function(){OpenLayers.Control.prototype.draw.apply(this,[]);this.map.onEvent("load",OpenLayers.Function.bind(this.create,this));
return this.div},updateCrossDiv:function(){this.crossdivH.style.width=this.crossWidth+"px";this.crossdivH.style.height=this.crossLineWidth+"px";this.crossdivV.style.width=this.crossLineWidth+"px";this.crossdivV.style.height=this.crossHeight+"px"},create:function(){this.server=this.map.server;this.minscale=this.map.minLogicalScale;
this.maxscale=this.map.maxLogicalScale;this.mapName=this.mapName||this.map.baseLayer.getMapName();this.tabName=this.tabName||this.map.baseLayer.tabname;var f;for(f=0;f<this.maxscale;f++){this.zooms[f]=1;this.scales[f]=this.maxscale}if(this.tabgrad){this.zooms=this.tabgrad;this.zoomsFixed=true}if(this.tabscales){this.scales=this.tabscales
}this.autoZoomReduction=true;this.sizeProportion=60/100;this.margins=[8,-2,-1,7];if(this.isFixed){this.sizeProportion=1;var d=this.map.precision;var k=this.map.baseLayer.maxExtent;var b=[k.left/d,k.right/d,k.bottom/d,k.top/d];this.initCenterX=b[0]+(b[1]-b[0])/2;this.initCenterY=b[2]+(b[3]-b[2])/2;this.autoZoomReduction=false
}if(!this.outsideViewport){OpenLayers.Element.addClass(this.div,"mapglobalview");this.div.style.width=this.width+"px";this.div.style.height=this.height+"px";this.calcGlobalViewPositions()}this.minidiv=document.createElement("div");this.minidiv.innerHTML="";this.tileWidth=this.map.baseLayer.tileSize.w;
this.tileHeight=this.map.baseLayer.tileSize.h;this.marginX=200;this.marginY=200;var h=this.map.size.w+2*this.marginX;var j=this.map.size.h+2*this.marginY;var g=Math.floor(h/this.tileWidth)+2;var e=Math.floor(j/this.tileHeight)+2;var c;var a;this.images=[];this.animImages=[];this.nbTileX=g;this.nbTileY=e;
for(c=0;c<this.nbTileX;c++){this.images[c]=[];this.animImages[c]=[];for(a=0;a<this.nbTileY;a++){this.images[c][a]=this.createImage(this.minidiv,0)}}this.minidiv.className="minidiv";this.minidiv.style.position="absolute";this.minidiv.style.width=this.width+"px";this.minidiv.style.height=this.height+"px";
this.divEvents=new OpenLayers.Events(this,this.minidiv,null,false);this.divEvents.on({mousemove:OpenLayers.Event.stop});this.div.appendChild(this.minidiv);this.pandiv=document.createElement("div");this.pandiv.className="pandiv";this.pandiv.style.position="absolute";this.crossdivH=document.createElement("div");
this.crossdivH.className="crossdivHorizontal";this.crossdivH.style.position="absolute";this.crossdivV=document.createElement("div");this.crossdivV.className="crossdivVertical";this.crossdivV.style.position="absolute";this.updateCrossDiv();this.minidiv.appendChild(this.pandiv);this.minidiv.appendChild(this.crossdivH);
this.minidiv.appendChild(this.crossdivV);this.divIco=document.createElement("div");this.divIco.className="mapglobalviewico";this.div.appendChild(this.divIco);this.divIco.onclick=OpenLayers.Function.bind(this.animateView,this);this.map.events.register("moveend",this,this.refresh);this.handlers.drag=new OpenLayers.Handler.Drag(this,{down:this.pan,move:this.panMove,done:this.panUp},{});
this.rectEvents=new OpenLayers.Events(this,this.pandiv,null,false);this.eventPan=OpenLayers.Function.bindAsEventListener(this.pan,this);this.eventPanMove=OpenLayers.Function.bindAsEventListener(this.panMove,this);this.eventPanUp=OpenLayers.Function.bindAsEventListener(this.panUp,this);this.rectEvents.register("mouseover",this,function(i){if(!this.handlers.drag.active&&!this.map.dragging){this.handlers.drag.activate();
this.divEvents.un({mousemove:OpenLayers.Event.stop})}if(this.outsideViewport){OpenLayers.Event.observe(document,"mousedown",this.eventPan)}});this.rectEvents.register("mouseout",this,function(i){if(!this.handlers.drag.dragging){this.handlers.drag.deactivate();this.divEvents.on({mousemove:OpenLayers.Event.stop})
}if(this.outsideViewport){OpenLayers.Event.stopObserving(document,"mousedown",this.eventPan)}});this.divEvents.on({mouseover:function(){this.divEvents.on({click:this.centerMap})},scope:this});this.divEvents.on({mouseout:function(){this.divEvents.un({click:this.centerMap})},scope:this});this.moveStart();
this.refresh(true);this.created=true},getLogicalScale:function(){return this.map.getNumZoomLevels()-this.map.zoom},createImage:function(f,e){var d=document.createElement("img");var a=this.getLogicalScale();var c=this.zooms[a-1];d.style.width=Math.round(this.tileWidth*c+0.5)+"px";d.style.height=Math.round(this.tileHeight*c+0.5)+"px";
d.style.display="none";d.style.position="absolute";d.style.left="-500px";d.style.zIndex=e;d.style.border="0";d.galleryImg=false;d.src=this.defaultImg;f.appendChild(d);var b={nosrc:true,image:d,visible:false};return b},calcMapTileWidth:function(){var a=this.map.getNumZoomLevels()-this.scales[this.getLogicalScale()-1];
var b=this.map.precision/this.map.getResolutionForZoom(a);return this.tileWidth/b},calcMapTileHeight:function(){var a=this.map.getNumZoomLevels()-this.scales[this.getLogicalScale()-1];var b=this.map.precision/this.map.getResolutionForZoom(a);return this.tileHeight/b},calcNumTileX:function(a){return Math.floor(a/this.calcMapTileWidth())
},calcNumTileY:function(a){return Math.floor(a/this.calcMapTileHeight())},calcMapDeltaX:function(c,b){var a=this.map.getNumZoomLevels()-this.scales[this.getLogicalScale()-1];var d=this.map.precision/this.map.getResolutionForZoom(a);return c+b/d},calcMapDeltaY:function(c,b){var a=this.map.getNumZoomLevels()-this.scales[this.getLogicalScale()-1];
var d=-this.map.precision/this.map.getResolutionForZoom(a);return c+b/d},panMove:function(s){this.panning=true;var m=this.pandiv;var l=this.getXposition(s);var o=this.getYposition(s);var j=l-m.tmpX;var i=o-m.tmpY;var k=OpenLayers.Util.pagePosition(this.div)[0];var t=OpenLayers.Util.pagePosition(this.div)[1];
m.style.top=(parseInt(m.style.top,10)+i)+"px";m.style.left=(parseInt(m.style.left,10)+j)+"px";m.tmpX=l;m.tmpY=o;var a=OpenLayers.Util.pagePosition(m)[0];var c=OpenLayers.Util.pagePosition(m)[1];var e=k+parseInt(this.width,10)-a+j-parseInt(m.style.width,10);var b=a+parseInt(m.style.left,10)+j-k+parseInt(this.minidiv.style.left,10);
var h=t+parseInt(this.height,10)-c-parseInt(m.style.height,10);var n=c+parseInt(m.style.top,10)-t+parseInt(this.minidiv.style.top,10);var f=this.margins[0];var r=this.margins[1];var d=this.margins[2];var g=this.margins[3];if(!this.isFixed){if(e<f){m.style.left=(parseInt(m.style.left,10)-j-1)+"px";m.diffX=m.diffX-j-1
}if(b<r){m.style.left=(parseInt(m.style.left,10)-j+1)+"px";m.diffX=m.diffX-j+1}if(n<d){m.style.top=(parseInt(m.style.top,10)-i+1)+"px";m.diffY=m.diffY-i+1}if(h<g){m.style.top=(parseInt(m.style.top,10)-i-1)+"px";m.diffY=m.diffY-i-1}}if((e<f)||(b<r)||(h<g)||(n<d)){if(!this.miniscrolling&&!this.isFixed){this.miniscrolling=true
}}else{this.miniscrolling=false;var q=this.map.getCenter().lon/this.map.precision;var p=this.map.getCenter().lat/this.map.precision;m.beginDragX=q;m.beginDragY=p}if(this.outsideViewport){OpenLayers.Event.observe(document,"mouseup",this.eventPanUp)}},panUp:function(a){this.tempCurrentX=null;this.tempCurrentY=null;
var d=this.pandiv;var j=d.tmpX-d.beginDragCursorX+d.diffX;var i=d.tmpY-d.beginDragCursorY+d.diffY;var c=this.map.getCenter().lon/this.map.precision;var b=this.map.getCenter().lat/this.map.precision;d.beginDragX=c;d.beginDragY=b;this.panning=false;var g=this.getLogicalScale();var h=this.zooms[g-1];var e=this.calcMapDeltaX(d.beginDragX,j/h)*this.map.precision;
var f=this.calcMapDeltaY(d.beginDragY,i/h)*this.map.precision;this.map.setCenter(new OpenLayers.LonLat(e,f));if(this.outsideViewport){OpenLayers.Event.stopObserving(document,"mouseup",this.eventPanUp);OpenLayers.Event.stopObserving(document,"mousemove",this.eventPanMove)}},pan:function(c){if(c.preventDefault){c.preventDefault()
}var d=this.pandiv;d.beginDragCursorX=this.getXposition(c);d.beginDragCursorY=this.getYposition(c);var b=this.map.getCenter().lon/this.map.precision;var a=this.map.getCenter().lat/this.map.precision;d.beginDragX=b;d.beginDragY=a;d.tmpX=d.beginDragCursorX;d.tmpY=d.beginDragCursorY;d.diffX=0;d.diffY=0;
if(this.outsideViewport){OpenLayers.Event.observe(document,"mousemove",this.eventPanMove)}},moveStart:function(){this.centerStartPx=this.map.getViewPortPxFromLonLat(this.map.getCenter())},move:function(i,h,f){if(this.isFixed){this.positionRect()}else{if(!this.firstRefreshDone){this.refresh()}else{var e=this.map.getViewPortPxFromLayerPx(this.map.getViewPortPxFromLonLat(this.map.getCenter()));
i=e.x-this.centerStartPx.x;h=e.y-this.centerStartPx.y;if(Math.abs(i)>this.map.size.w/2||Math.abs(h)>this.map.size.h/2){this.refresh()}else{var a=this.pandiv.style;var d=this.minidiv.style;var g=this.zooms[this.getLogicalScale()-1];var b=this.map.getResolution()/this.map.precision;var c=b/(this.calcMapDeltaX(0,1/g));
d.top=Math.round((this.height-parseInt(d.height,10))/2)+c*h+"px";d.left=Math.round((this.width-parseInt(d.width,10))/2)+c*i+"px";a.top=Math.round(((this.height-parseInt(a.height,10))/2-parseInt(d.top,10)))+"px";a.left=Math.round(((this.width-parseInt(a.width,10))/2-parseInt(d.left,10)))+"px";this.positionCross()
}}}},calcLimits:function(){var g=this.map.precision;var d=this.map.baseLayer.maxExtent;var a=[d.left/g,d.right/g,d.bottom/g,d.top/g];var c=this.calcNumTileX(a[0]);var b=this.calcNumTileX(a[1]);var f=this.calcNumTileY(a[2]);var e=this.calcNumTileY(a[3]);this.tileLimits=[c,b+1,f,e+1]},isVisible:function(){return this.visible
},calcTileSrc:function(b){var c=this.format;var a=this.getLogicalScale();var e=this.scales[a-1];var d=[this.server,escape(this.mapName),0,escape(this.tabName),c,this.tileWidth,this.tileHeight,e,b.mapTileX,b.mapTileY+"."+c.substring(0,3)];return d.join("/")},clearImage:function(c){c.image.src=this.defaultImg;
c.image.style.display="none";var a=this.getLogicalScale();var b=this.zooms[a-1];c.image.style.width=Math.round(this.tileWidth*b+0.5)+"px";c.image.style.height=Math.round(this.tileHeight*b+0.5)+"px";c.nosrc=true;c.visible=false;c.image.galleryImg=false},clearAll:function(a){if(!a){return}var d,c,b;for(d=0;
d<this.nbTileX;d++){for(c=0;c<this.nbTileY;c++){b=a[d][c];this.clearImage(b)}}},refresh:function(b){if(!this.outsideViewport&&b){this.calcGlobalViewPositions()}if(!this.visible||!this.map.initialized){return}var i,f,j,g;var q,o,h,e;var r,l,k,c;if(!this.isFixed||!this.firstRefreshDone){this.clearAll(this.images);
this.calcLimits();i=Math.floor(this.nbTileX/2);f=Math.floor(this.nbTileY/2);this.centerX=Math.floor(this.map.size.w/2);this.centerY=Math.floor(this.map.size.h/2);var n=this.tempCurrentX?this.tempCurrentX:this.map.getCenter().lon/this.map.precision;var m=this.tempCurrentY?this.tempCurrentY:this.map.getCenter().lat/this.map.precision;
j=this.initCenterX?this.initCenterX:n;g=this.initCenterY?this.initCenterY:m;q=this.calcNumTileX(j);o=this.calcNumTileY(g);for(h=0;h<this.nbTileX;h++){for(e=0;e<this.nbTileY;e++){r=this.images[h][e];l=q+h-i;k=o+e-f;this.fillImage(r,l,k);this.updateMapImage(r)}}var p=this.getLogicalScale();var a=this.zooms[p-1];
c=this.minidiv.style;c.width=a*this.map.size.w+"px";c.height=a*this.map.size.h+"px"}if(b||(this.pandiv.style.height=="")){this.resizeRect()}if(!this.panning){if(!this.isFixed||!this.firstRefreshDone){var d=this.pandiv.style;c=this.minidiv.style;c.top=Math.round((this.height-parseInt(c.height,10))/2)+"px";
c.left=Math.round((this.width-parseInt(c.width,10))/2)+"px";d.top=Math.round(((this.height-parseInt(d.height,10))/2-parseInt(c.top,10)))+"px";d.left=Math.round(((this.width-parseInt(d.width,10))/2-parseInt(c.left,10)))+"px";this.positionCross()}else{this.positionRect()}}this.firstRefreshDone=true},setAutoZoomReduction:function(a){this.autoZoomReduction=a
},setRectSize:function(b,a){this.rectSizeFixed=true;this.rectWidth=b;this.rectHeight=a},resizeRect:function(){var a=this.getLogicalScale();var b=this.map.getResolution()/this.map.precision;this.panzoomx=b/(this.calcMapDeltaX(0,1/this.zooms[a-1]));if(this.autoZoomReduction){while(Math.round(this.panzoomx*this.map.size.w)+10>(this.sizeProportion*this.width)){if(!this.isFixed){this.scales[a-1]++;
if(this.scales[a-1]>this.map.getNumZoomLevels()){this.scales[a-1]=this.map.getNumZoomLevels();this.zooms[a-1]=Math.round(this.zooms[a-1]*80)/100}}else{this.zooms[a-1]=Math.round(this.zooms[a-1]*80)/100}this.panzoomx=b/(this.calcMapDeltaX(0,1/this.zooms[a-1]));this.refresh()}}var c;if(!this.rectSizeFixed){if(Math.round(this.panzoomx*this.map.size.w)<1){this.pandiv.style.width="1px"
}else{this.pandiv.style.width=Math.round(this.panzoomx*this.map.size.w)+"px"}c=-b/(this.calcMapDeltaY(0,1/this.zooms[a-1]));if(Math.round(c*this.map.size.h)<1){this.pandiv.style.height="1px"}else{this.pandiv.style.height=Math.round(c*this.map.size.h)+"px"}}else{this.pandiv.style.width=this.rectWidth+"px";
this.pandiv.style.height=this.rectHeight+"px"}},positionRect:function(){if(!this.panning){var b=this.getLogicalScale();var e=this.zooms[b-1];var c=this.map.getCenter().lon/this.map.precision;var a=this.map.getCenter().lat/this.map.precision;var f=this.map.getNumZoomLevels()-this.scales[this.getLogicalScale()-1];
var d=this.map.precision/this.map.getResolutionForZoom(f);this.pandiv.style.top=Math.round((e*d*(this.initCenterY-a)+(this.height-parseInt(this.pandiv.style.height,10))/2-parseInt(this.minidiv.style.top,10)))+"px";this.pandiv.style.left=Math.round((e*(-d)*(this.initCenterX-c)+(this.width-parseInt(this.pandiv.style.width,10))/2-parseInt(this.minidiv.style.left,10)))+"px";
this.positionCross()}},positionCross:function(){var b=this.pandiv.style;var a=parseInt(b.width,10)/2;var f=parseInt(b.height,10)/2;var e=parseInt(b.left,10);var d=parseInt(b.top,10);var c=this.crossLineWidth/2;this.crossdivV.style.left=a+e-c-1+"px";this.crossdivV.style.top=f+d-c-(this.crossHeight/2)+"px";
this.crossdivH.style.left=a+e-c-(this.crossWidth/2)+"px";this.crossdivH.style.top=f+d-c-1+"px"},fillImage:function(e,c,b){e.mapTileX=c;e.mapTileY=b;var a=this.calcMapTileWidth();var d=this.calcMapTileHeight();e.mapx=Math.round(a*c+a/2);e.mapy=Math.round(d*b+d/2);this.positionImage(e);e.nosrc=true;e.visible=false
},calcPixelX:function(b){var d=this.initCenterX?this.initCenterX:this.map.getCenter().lon/this.map.precision;var e=this.map.size.w/2;var a=this.map.getNumZoomLevels()-this.scales[this.getLogicalScale()-1];var c=this.map.precision/this.map.getResolutionForZoom(a);return Math.round(e+(b-d)*c)},calcPixelY:function(b){var d=this.initCenterY?this.initCenterY:this.map.getCenter().lat/this.map.precision;
var e=this.map.size.h/2;var a=this.map.getNumZoomLevels()-this.scales[this.getLogicalScale()-1];var c=-this.map.precision/this.map.getResolutionForZoom(a);return Math.round(e+(b-d)*c)},positionImage:function(b){var c=this.getLogicalScale();var a=this.zooms[c-1];b.posx=a*(this.calcPixelX(0)+this.tileWidth*b.mapTileX);
b.posy=a*(this.calcPixelY(0)-this.tileHeight*b.mapTileY-this.tileHeight)},updateMapImage:function(c){var d=true;var b=2;var a=2;var f;if(!(new OpenLayers.Bounds(c.posx,c.posy,c.posx+this.tileWidth,c.posy+this.tileHeight)).intersectsBounds(new OpenLayers.Bounds(-b,-a,this.map.size.w+b,this.map.size.h+a))){d=false
}if(!d){if(c.visible){this.clearImage(c)}}else{var e=this.getLogicalScale();if(c.nosrc){if(!this.isVisible()||e>this.maxscale||e<this.minscale||!new OpenLayers.Bounds(this.tileLimits[0],this.tileLimits[2],this.tileLimits[1],this.tileLimits[3]).contains(c.mapTileX,c.mapTileY)){c.image.src=this.defaultImg;
c.loadImage=null}else{f=this.calcTileSrc(c);c.image.src=f}c.nosrc=false}if(!c.visible){c.image.style.display="";c.visible=true}c.image.style.left=c.posx+"px";c.image.style.top=c.posy+"px"}},correctMapImage:function(c){var d=0;var b=0;var a=0;if(c.posx>this.map.size.w+this.marginX+a){d=-this.nbTileX}else{if(c.posx<-this.marginX-this.tileWidth-a){d=this.nbTileX
}}if(c.posy>this.map.size.h+this.marginY+a){b=-this.nbTileY}else{if(c.posy<-this.marginY-this.tileHeight-a){b=this.nbTileY}}if(d!==0||b!==0){this.fillImage(c,c.mapTileX+d,c.mapTileY-b);this.clearImage(c)}this.updateMapImage(c)},calcGlobalViewPositions:function(){if(this.initialx<0){this.posx=this.map.size.w+this.initialx-this.width-1
}if(this.initialy<0){this.posy=this.map.size.h+this.initialy-this.height-1}this.div.style.left=this.posx+"px";this.div.style.top=this.posy+"px"},getXposition:function(a){if(window.event){return window.event.clientX+document.documentElement.scrollLeft+document.body.scrollLeft}else{return(a.clientX||a.x)+(window.scrollX||0)
}},getYposition:function(a){if(window.event){return window.event.clientY+document.documentElement.scrollTop+document.body.scrollTop}else{return(a.clientY||a.y)+(window.scrollY||0)}},centerMap:function(b){var h=this.map.getCenter().lon/this.map.precision;var g=this.map.getCenter().lat/this.map.precision;
var p=this.initCenterX?this.initCenterX:h;var m=this.initCenterY?this.initCenterY:g;var l=this.getXposition(b);var e=this.getYposition(b);var f=OpenLayers.Util.pagePosition(this.div)[0];var a=OpenLayers.Util.pagePosition(this.div)[1];var d=f+this.width/2;var c=a+this.height/2;var q=l-d;var o=e-c;var i=this.getLogicalScale();
var n=this.zooms[i-1];var j=this.calcMapDeltaX(p,q/n)*this.map.precision;var k=this.calcMapDeltaY(m,o/n)*this.map.precision;this.map.panTo(new OpenLayers.LonLat(j,k))},remove:function(a){if(!this.outsideViewport){this.div.parentNode.removeChild(this.div)}else{this.clear()}},clear:function(){this.div.removeChild(this.minidiv);
this.div.removeChild(this.divIco)},animateView:function(){var a=new GCUI.MapAnimator.GlobalView(this,800);a.play()},destroy:function(){if(this.handlers.drag){this.handlers.drag.destroy()}if(this.rectEvents){this.rectEvents.destroy();this.rectEvents=null}if(this.divEvents){this.divEvents.destroy();this.divEvents=null
}this.map.events.un({moveend:this.refresh,scope:this});OpenLayers.Control.prototype.destroy.apply(this,[])},CLASS_NAME:"GCUI.Control.GlobalView"});GCUI.MapAnimator={};GCUI.MapAnimator.GlobalView=OpenLayers.Class({initialize:function(a,b){this.gv=a;this.totalTime=b;this.startTime=(new Date()).getTime();
this.endTime=this.startTime+b;GCUI.MapAnimator.current=this;return this},animate:function(){if(this.finished){return}var c=(new Date()).getTime();if(c>this.endTime||this.gv.width<0||this.gv.width>this.gv.initialw||this.gv.height<0||this.gv.height>this.gv.initialh){this.stop();return}var d=(c-this.startTime)/this.totalTime;
if(d>1){d=1}var b=this.gv.initialw*d;var a=this.gv.initialh*d;if(this.gv.visible){this.gv.width=(this.gv.width-b);this.gv.height=(this.gv.height-a);if(!this.gv.outsideViewport){this.gv.calcGlobalViewPositions()}if(this.gv.width>0&&this.gv.height>0){this.gv.div.style.width=this.gv.width+"px";this.gv.div.style.height=this.gv.height+"px"
}}else{this.gv.width=(this.gv.width+b);this.gv.height=(this.gv.height+a);if(!this.gv.outsideViewport){this.gv.calcGlobalViewPositions()}if(this.gv.width<this.gv.initialw&&this.gv.height<this.gv.initialh){this.gv.div.style.width=this.gv.width+"px";this.gv.div.style.height=this.gv.height+"px"}}},stop:function(){this.finished=true;
if(this.gv.visible){this.gv.visible=false;this.gv.width=parseInt(this.gv.divIco.clientWidth,10);this.gv.height=parseInt(this.gv.divIco.clientHeight,10);this.gv.div.style.width=this.gv.divIco.clientWidth+"px";this.gv.div.style.height=this.gv.divIco.clientHeight+"px";this.gv.divIco.className="mapglobalviewico2"
}else{this.gv.visible=true;this.gv.width=parseInt(this.gv.initialw,10);this.gv.height=parseInt(this.gv.initialh,10);this.gv.div.style.width=this.gv.initialw+"px";this.gv.div.style.height=this.gv.initialh+"px";this.gv.divIco.className="mapglobalviewico";this.gv.refresh()}if(!this.gv.outsideViewport){this.gv.calcGlobalViewPositions()
}},isFinished:function(){return this.finished},play:function(a){if(!a){a=1}if(!this.isFinished()){this.animate();window.setTimeout("GCUI.MapAnimator.current.play("+a+");",a)}}});GCUI.Control.OverviewMap=OpenLayers.Class(OpenLayers.Control.OverviewMap,{size:{w:150,h:150},autoPan:true,maximized:true,createMap:function(){var b=OpenLayers.Util.extend({controls:[],maxResolution:"auto",fallThrough:false},this.mapOptions);
this.ovmap=new GCUI.Map(this.mapDiv,b);this.ovmap.viewPortDiv.appendChild(this.extentRectangle);OpenLayers.Event.stopObserving(window,"unload",this.ovmap.unloadDestroy);this.ovmap.addLayers(this.layers);this.ovmap.zoomToMaxExtent();this.wComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-left-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-right-width"));
this.wComp=(this.wComp)?this.wComp:2;this.hComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-top-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-bottom-width"));this.hComp=(this.hComp)?this.hComp:2;this.handlers.drag=new OpenLayers.Handler.Drag(this,{move:this.rectDrag,done:this.updateMapToRect},{map:this.ovmap});
this.handlers.click=new OpenLayers.Handler.Click(this,{click:this.mapDivClick},{single:true,"double":false,stopSingle:true,stopDouble:true,pixelTolerance:1,map:this.ovmap});this.handlers.click.activate();this.rectEvents=new OpenLayers.Events(this,this.extentRectangle,null,true);this.rectEvents.register("mouseover",this,function(d){if(!this.handlers.drag.active&&!this.map.dragging){this.handlers.drag.activate()
}});this.rectEvents.register("mouseout",this,function(d){if(!this.handlers.drag.dragging){this.handlers.drag.deactivate()}});if(this.ovmap.getProjection()!=this.map.getProjection()){var c=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units;var a=this.ovmap.getProjectionObject().getUnits()||this.ovmap.units||this.ovmap.baseLayer.units;
this.resolutionFactor=c&&a?OpenLayers.INCHES_PER_UNIT[c]/OpenLayers.INCHES_PER_UNIT[a]:1}},CLASS_NAME:"GCUI.Control.OverviewMap"});GCUI.Control.GeoConceptGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:false,drillDown:false,maxFeatures:10,clickCallback:"click",layers:null,queryVisible:true,infoFormat:"text/html",handlerOptions:null,handler:null,hoverRequest:null,EVENT_TYPES:["beforegetfeatureinfo","getfeatureinfo","exception"],pending:0,infoMode:"infoboxfields",initialize:function(a){this.EVENT_TYPES=this.EVENT_TYPES.concat(OpenLayers.Control.prototype.EVENT_TYPES);
a=a||{};a.handlerOptions=a.handlerOptions||{};OpenLayers.Control.prototype.initialize.apply(this,[a]);if(this.drillDown===true){this.hover=false}if(this.hover){this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},this.handlerOptions.hover||{})}else{var b={};
b[this.clickCallback]=this.getInfoForClick;this.handler=new OpenLayers.Handler.Click(this,b,this.handlerOptions.click||{})}},getInfoForClick:function(a){this.request(a.xy,{})},getInfoForHover:function(a){if(this.hoverXY&&this.hoverXY.x==a.xy.x&&this.hoverXY.y==a.xy.y){return}this.hoverXY=a.xy;this.request(a.xy,{hover:true})
},cancelHover:function(){if(this.hoverRequest){--this.pending;if(this.pending<=0){OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait");this.pending=0}}},findLayers:function(){var c=this.layers||this.map.layers;var d=[];var b;for(var a=c.length-1;a>=0;--a){b=c[a];if(b.CLASS_NAME==="GCUI.Layer.GeoConcept"&&(!this.queryVisible||b.getVisibility())&&b.opacity>0){d.push(b);
if(!this.drillDown||this.hover){break}}}return d},buildRequestOptions:function(a,b){var c=this.map.getLonLatFromPixel(b);return{url:a.getUrlGC()+"/api/gcis/json/feature/",loc:c}},request:function(g,c){c=c||{};var f=this.findLayers();if(f.length>0){var b,e;for(var d=0,a=f.length;d<a;d++){e=f[d];b=this.triggerBefore(g,e);
if(b!==false){++this.pending;var h=this.getProtocol(e,g);if(c.hover===true){this.hoverRequest=h}h.read()}}if(this.pending>0){OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait")}}},triggerBefore:function(b,a){return this.events.triggerEvent("beforegetfeatureinfo",{xy:b,layer:a})},getOffsetX:function(a){return(a.singleTile?(a.tileSize.w-a.tileSize.w/a.ratio)/2:0)
},getOffsetY:function(a){return(a.singleTile?(a.tileSize.h-a.tileSize.h/a.ratio)/2:0)},createProtocol:function(a,d,b,c,e){return new OpenLayers.Protocol.Script({url:a,params:d,handleResponse:function(g,f){if(g.data&&g.data.status==="OK"){g.responseText=g.data.result;g.code=OpenLayers.Protocol.Response.SUCCESS
}else{g.status=g.data.http?g.data.http.code||400:400;g.statusText=g.data?g.data.message||"":"";g.code=OpenLayers.Protocol.Response.FAILURE}this.destroyRequest(g.priv);f.callback.call(f.scope,g)},callback:e||function(f){this.handleResponse(c,f,b)},scope:this})},getProtocol:function(b,d){var a=this.buildRequestOptions(b,d);
var c=(this.serviceFormat==="html")?"html":"text";return this.createProtocol(a.url+"info/"+c,{mapName:b.mapname,tabName:b.tabname,x:a.loc.lon,y:a.loc.lat,infoMode:this.infoMode,scale:this.map.getLogicalScale()},b,d)},handleResponse:function(c,b,a){--this.pending;if(this.pending<=0){OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait");
this.pending=0}if(b.code===OpenLayers.Protocol.Response.FAILURE){this.events.triggerEvent("exception",{xy:c,request:b,layer:a})}else{this.events.triggerEvent("getfeatureinfo",{text:b.responseText,request:b,xy:c,layer:a})}},getFeature:function(c){var f=this.findLayers();if(f.length>0){for(var e=0,a=f.length;
e<a;e++){var d=f[e];var b=this.triggerBefore(null,d);if(b!==false){var h=OpenLayers.Util.extend({url:d.getUrlGC()+"/api/gcis/json/feature/get",params:{mapName:d.mapname,userSessionID:d.userId,featureID:c.featureId,type:this.type,subtype:this.subtype},handleResponse:function(j,i){this.destroyRequest(j.priv);
i.callback.call(i.scope,j.data,i)},scope:this},c);var g=new OpenLayers.Protocol.Script(h);g.read()}}}},CLASS_NAME:"GCUI.Control.GeoConceptGetFeatureInfo"});GCUI.Control.GeoConceptSelectFeature=OpenLayers.Class(GCUI.Control.GeoConceptGetFeatureInfo,{type:null,subtype:null,EVENT_TYPES:["beforefeatureselected","featureselected","exception","zoomOnSelection"],selectedFeatures:[],box:false,selectOperation:"xor",strictInclusion:true,layers:null,maxSelectedData:null,initialize:function(a){GCUI.Control.GeoConceptGetFeatureInfo.prototype.initialize.apply(this,[a]);
if(this.box){this.handler=new OpenLayers.Handler.Box(this,{done:this.selectBox},{boxDivClassName:"olHandlerBoxSelectFeature"})}if(this.polygon){var b={done:this.selectByPolygon};this.callbacks=OpenLayers.Util.extend(b,this.callbacks);this.handlerOptions=OpenLayers.Util.extend({persist:this.persist},this.handlerOptions);
this.handler=new OpenLayers.Handler.Polygon(this,this.callbacks,this.handlerOptions)}},triggerBefore:function(b,a){return this.events.triggerEvent("beforefeatureselected",{xy:b,layer:a})},getProtocolParams:function(a){return{op:this.selectOperation,mapName:a.mapname,userSessionID:a.userId,fields:this.dataFields.join(","),strict:this.strictInclusion}
},getProtocol:function(a,b){var c=this.getProtocolParams(a);c.clickX=this.getOffsetX(a)+b.x;c.clickY=this.getOffsetY(a)+b.y;return this.createProtocol(a.getUrlGC()+"/api/gcis/json/feature/selectByPoint",c,a,b)},handleResponse:function(c,b,a){--this.pending;if(this.pending<=0){OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait");
this.pending=0}if(b.code===OpenLayers.Protocol.Response.FAILURE){this.events.triggerEvent("exception",{xy:c,request:b,layer:a})}else{this.selectedFeatures=b.responseText;this.events.triggerEvent("featureselected",{text:b.responseText,request:b,xy:c,layer:a})}a.redraw()},selectByIds:function(a){var g="";
for(var e=0;e<a.length;e++){g+=this.keyField+";"+a[e]+","}var d=this.findLayers();if(d.length>0){for(var e=0,h=d.length;e<h;e++){var f=d[e];var j=this.triggerBefore(null,f);if(j!==false){var c=this.getProtocolParams(f);c.type=this.type;c.subtype=this.subtype;c.criteria=g;c.operator="or";var b=this.createProtocol(f.getUrlGC()+"/api/gcis/json/features/select",c,f);
b.read()}}}},clearSelection:function(){var e=this.findLayers();if(e.length>0){for(var c=0,a=e.length;c<a;c++){var b=e[c];var d=this.createProtocol(b.getUrlGC()+"/api/gcis/json/features/select/clear",{userSessionID:b.userId},b);d.read()}}},zoomOnSelection:function(){var e=this.findLayers();if(e.length>0){for(var c=0,a=e.length;
c<a;c++){var b=e[c];var f={mapName:b.mapname,userSessionID:b.userId,zoomOnSelection:true,sizeX:b.tileSize.w/b.ratio,sizeY:b.tileSize.h/b.ratio,tick:new Date().getTime()};var d=this.createProtocol(b.getUrlGC()+"/api/gcis/json/currentPosition",f,b,null,function(h){var g=h.responseText;b.map.setCenter(new OpenLayers.LonLat(g.posX/100,g.posY/100),12-g.scale);
this.events.triggerEvent("zoomOnSelection",{lon:g.posX/100,lat:g.posY/100,z:12-g.scale})});d.read()}}},selectBox:function(h){if(h instanceof OpenLayers.Bounds){var g=this.findLayers();var i;for(var e=0;e<g.length;++e){i=g[e];var d=this.getOffsetX(i)+h.left;var k=this.getOffsetY(i)+h.bottom;var b=this.getOffsetX(i)+h.right;
var j=this.getOffsetY(i)+h.top;var a=i.getUrlGC()+"/api/gcis/json/feature/selectByPoly";var f=this.getProtocolParams(i);f.clickMap=[[d,k].join(","),[d,j].join(","),[b,j].join(","),[b,k].join(","),[d,k].join(",")].join(";");var c=this.createProtocol(a,f,i);c.read()}}},selectByPolygon:function(q){var j=q.components[0];
var m=j.components;var n=m.length;var e=[];for(var h=0;h<n;++h){var o=m[h];var s=this.map.getPixelFromLonLat(new OpenLayers.LonLat(o.x,o.y));e.push(s)}var g=this.findLayers();var k;for(var d=0;d<g.length;++d){k=g[d];var r=[];for(h=0;h<n;++h){r.push((this.getOffsetX(k)+e[h].x)+","+(this.getOffsetY(k)+e[h].y))
}var a=k.getUrlGC()+"/api/gcis/json/feature/selectByPoly";var f=this.getProtocolParams(k);f.clickMap=r.join(";");if(this.maxSelectedData){f.dataRange="1,"+this.maxSelectedData}var b=this.createProtocol(a,f,k);b.read()}},CLASS_NAME:"GCUI.Control.GeoConceptSelectFeature"});GCUI.Control.Route=OpenLayers.Class(OpenLayers.Control,{layer:null,simplifiedMinScale:8,simplifiedMaxScale:12,routes:[],url:null,setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,[a]);
this.map.events.register("zoomend",this,this.updateFeatures)},route:function(b){var d=[];var a=b.waypoints?b.waypoints.length:0;for(var c=0;c<a;c++){d.push(b.waypoints[c].toShortString())}var f=OpenLayers.Util.extend({url:this.url||(this.map?this.map.baseLayer.getUrlGC()+"/api/lbs/route"+(b.version||"")+".json":""),params:{origin:b.origin.toShortString(),destination:b.destination.toShortString(),tolerance:b.tolerance||0.001,waypoints:d.join(";")},handleResponse:function(h,g){this.destroyRequest(h.priv);
g.callback.call(g.scope,h.data,g)},scope:this},b);if(b.graph){f.params.graph=b.graph}if(b.srs){f.params.srs=b.srs}if(b.format){f.params.format=b.format}if(GCUI.Settings){OpenLayers.Util.applyDefaults(f.params,GCUI.Settings)}var e=new OpenLayers.Protocol.Script(f);e.read()},displayRoute:function(z,c){if(z.errors!==undefined||z.legs.length===0){return null
}if(!this.layer){this.layer=new OpenLayers.Layer.Vector("routeLayer"+this.id,{displayInLayerSwitcher:false,style:{strokeColor:"#1BE01B",strokeWidth:2}});this.map.addLayer(this.layer)}var g=[];var e=(c&&c.style)?c.style:null;var d=false;var b=true;if(c&&c.params&&c.params.srs){b=false}if(z.wktGeometry||z.geometryWkt){var u=new OpenLayers.Format.WKT().read(z.geometryWkt?z.geometryWkt:z.wktGeometry);
u.style=e;u.attributes=OpenLayers.Util.extend({duration:z.duration,distance:z.distance},c?c.data:{});if(b){u.geometry.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection(this.map.getProjection()))}g.push(u)}else{for(var w=0,k=z.legs.length;w<k;++w){var o=z.legs[w];for(var n=0,y=o.steps.length;
n<y;n++){var h=o.steps[n];var v=[];for(var q=0,m=h.points.length;q<m;q++){var t=OpenLayers.LonLat.fromString(h.points[q]);v.push(new OpenLayers.Geometry.Point(t.lon,t.lat));d=true}var j=OpenLayers.Util.extend({duration:h.duration,distance:h.distance,navInstruction:h.navInstruction,name:h.name},c?c.data:{});
var f=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(v),j,e);if(b){f.geometry.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection(this.map.getProjection()))}g.push(f)}}}var x=new OpenLayers.Format.WKT().read(z.simplifiedWkt?z.simplifiedWkt:z.wktSimplifiedGeometry);
x.style=e;x.attributes=OpenLayers.Util.extend({duration:z.duration,distance:z.distance},c?c.data:{});if(b){x.geometry.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection(this.map.getProjection()))}var a=this.map.getLogicalScale();if((this.simplifiedMinScale<=a&&this.simplifiedMaxScale>=a)||!d){this.layer.addFeatures([x])
}else{this.layer.addFeatures(g)}var l={features:g,simplifiedFeature:x};this.routes.push(l);return l},updateFeatures:function(){if(!this.layer){return}var d=this.map.getLogicalScale();this.layer.removeAllFeatures();if((this.simplifiedMinScale<=d)&&(this.simplifiedMaxScale>=d)){var c=[];for(var b=0,a=this.routes.length;
b<a;b++){c.push(this.routes[b].simplifiedFeature)}this.layer.addFeatures(c)}else{for(b=0,a=this.routes.length;b<a;b++){this.layer.addFeatures(this.routes[b].features)}}},CLASS_NAME:"GCUI.Control.Route"});GCUI.Control.GeoCode=OpenLayers.Class(OpenLayers.Control,{geocode:function(a){var c=OpenLayers.Util.extend({url:this.map?this.map.baseLayer.getUrlGC()+"/api/lbs/geocode/json":"",params:{cc:a.countryCode,al:a.addressLine,pc:a.postalCode,ci:a.city,pr:a.projection,mr:a.maxResponses},handleResponse:function(e,d){this.destroyRequest(e.priv);
d.callback.call(d.scope,e.data,d)},scope:this},a);if(GCUI.Settings){OpenLayers.Util.applyDefaults(c.params,GCUI.Settings)}var b=new OpenLayers.Protocol.Script(c);b.read()},CLASS_NAME:"GCUI.Control.GeoCode"});GCUI.Control.Print=OpenLayers.Class(OpenLayers.Control,{draw:function(b){var d=OpenLayers.Control.prototype.draw.apply(this,[b]);
var c=document.createElement("form");c.method="POST";c.target="_blank";this.form=c;var a=document.createElement("input");a.name="data";a.type="hidden";this.dataInput=a;c.appendChild(a);d.appendChild(c);return d},print:function(){var a=this.map.toJSON();this.dataInput.value=a;this.form.action=this.printUrl||(this.map?this.map.baseLayer.getUrlGC()+"/api/htc/print/image":"");
this.form.submit()},CLASS_NAME:"GCUI.Control.Print"});GCUI.Control.Click=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{single:true,"double":false,pixelTolerance:0,stopSingle:false,stopDouble:false},initialize:function(a){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions);
OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.onClick,dblclick:this.onDblclick},this.handlerOptions)},onClick:function(a){},onDblclick:function(a){},CLASS_NAME:"GCUI.Control.Click"});GCUI.Control.RightClick=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{single:true,"double":false,pixelTolerance:0,stopSingle:false,stopDouble:false},handleRightClicks:true,initialize:function(a){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions);
OpenLayers.Control.prototype.initialize.apply(this,[a]);this.handler=new OpenLayers.Handler.Click(this,{rightclick:this.onRightClick},this.handlerOptions)},CLASS_NAME:"GCUI.Control.RightClick"});GCUI.Layer.Thematic=OpenLayers.Class(GCUI.Layer.GeoConcept,{isBaseLayer:false,transparent:true,singleTile:true,fieldId:"id",fieldValue:"legende0",noValueColor:"FF0000",type:"color",autoZoom:true,initialize:function(c,b,d,a){GCUI.Layer.GeoConcept.prototype.initialize.apply(this,[c,b,d,a])
},beforeInitLayer:function(){return false},loadMetadata:function(){if(this.userId){GCUI.Layer.GeoConcept.prototype.loadMetadata.apply(this,[])}},setMap:function(a){GCUI.Layer.GeoConcept.prototype.setMap.apply(this,[a]);this.createThematic(OpenLayers.Function.bind(function(c){var b=new OpenLayers.Format.JSON().read(c.priv.responseText).result;
this.userId=b.userId;this.initLayer();if(this.autoZoom===true){this.map.setCenter(new OpenLayers.LonLat(b.centerX,b.centerY),this.map.getNumZoomLevels()-b.scale)}this.checkMetadata()},this))},createThematic:function(e){var c=this.classes;var b=[];var k=[];for(var h=0;h<c.length;h++){k=[];for(var f in c[h]){if(c[h].hasOwnProperty(f)){k.push(f+":"+c[h][f])
}}b.push(k.join(","))}var g=this.data;var j=[];if(g){for(h=0;h<g.length;h++){k=[];for(f in g[h]){if(g[h].hasOwnProperty(f)){k.push(g[h][f])}}j.push(k.join(","))}}var d={mapName:this.getMapName(),tabName:this.tabname,sizeX:this.map.size.w,sizeY:this.map.size.h,fieldId:this.fieldId,fieldValue:this.fieldValue,noValueColor:this.noValueColor,classes:b.join(";"),thematicName:this.name,gcType:this.gcType,gcSubType:this.gcSubType,data:j.join(";"),tick:new Date().getTime()};
var a=new OpenLayers.Protocol.HTTP({url:this.getUrlGC()+"/api/gcis/thematic/json/"+this.type,params:d,handleResponse:function(l,i){i.callback.call(i.scope,l)},callback:function(i){e(i)},scope:this,readWithPOST:true});a.read()},getLegendUrl:function(a){var b=OpenLayers.Util.extend({uid:this.userId},a);
return this.getUrlGC()+"/api/gcis/thematic/image/legend?"+OpenLayers.Util.getParameterString(b)},CLASS_NAME:"GCUI.Layer.Thematic"});GCUI.Popup=GCUI.Popup||{};GCUI.Popup.Anchored=new OpenLayers.Class(OpenLayers.Popup.Anchored,{contentDisplayClass:"gcuiAnchoredContent",initialize:function(h,d,g,c,f,e,b){var a=[h,d,g,c,f,e];
OpenLayers.Popup.prototype.initialize.apply(this,a);this.anchor=(b!=null)?b:{size:new OpenLayers.Size(-40,40),offset:new OpenLayers.Pixel(20,-20)};h=this.div.id+"_bottomAnchorDiv";this.bottomAnchorDiv=OpenLayers.Util.createDiv(h,null,null,null,"relative");this.div.appendChild(this.bottomAnchorDiv);h=this.div.id+"_topAnchorDiv";
this.topAnchorDiv=OpenLayers.Util.createDiv(h,null,null,null,"relative");this.div.insertBefore(this.topAnchorDiv,this.groupDiv);this.groupDiv.className="gcuiPopupGroupDiv";this.useImg=(parseFloat(navigator.appVersion.split("MSIE")[1])<10)},setSize:function(a){OpenLayers.Popup.Anchored.prototype.setSize.apply(this,[a]);
this.div.style.height=(parseInt(this.div.style.height)+this.anchor.offset.x)+"px"},getContentDivPadding:function(){var a=this._contentDivPadding;if(!a){this.div.style.display="none";document.body.appendChild(this.div);a=new OpenLayers.Bounds(OpenLayers.Element.getStyle(this.contentDiv,"padding-left"),OpenLayers.Element.getStyle(this.contentDiv,"padding-bottom"),OpenLayers.Element.getStyle(this.contentDiv,"padding-right"),OpenLayers.Element.getStyle(this.contentDiv,"padding-top"));
this._contentDivPadding=a;if(this.div.parentNode==document.body){document.body.removeChild(this.div);this.div.style.display=""}}return a},updateRelativePosition:function(){var b=(this.relativePosition.charAt(0)=="t");this.bottomAnchorDiv.className="anchorDivBottom"+(this.useImg?"Img":this.relativePosition.charAt(1));
this.topAnchorDiv.className="anchorDivTop"+(this.useImg?"Img":this.relativePosition.charAt(1));if(b){this.topAnchorDiv.style.display="none";this.bottomAnchorDiv.style.display="block"}else{this.topAnchorDiv.style.display="block";this.bottomAnchorDiv.style.display="none"}var a=0;if(this.div.style.width!==""){a=parseInt(this.div.style.width)
}if(this.relativePosition.charAt(1)=="l"){this.bottomAnchorDiv.style.left=(a-2*this.anchor.offset.x)+"px";this.topAnchorDiv.style.left=(a-2*this.anchor.offset.x)+"px"}else{this.bottomAnchorDiv.style.left=this.anchor.offset.x+"px";this.topAnchorDiv.style.left=this.anchor.offset.x+"px"}},moveTo:function(a){this.relativePosition=this.calculateRelativePosition(a);
OpenLayers.Popup.prototype.moveTo.call(this,this.calculateNewPx(a));this.updateRelativePosition()},calculateNewPx:function(b){var e=b.offset(this.anchor.offset);var a=this.size||this.contentSize;var d=(this.relativePosition.charAt(0)=="t");e.y+=(d)?-a.h:(this.anchor.size.h-this.anchor.offset.x);var c=(this.relativePosition.charAt(1)=="l");
e.x+=(c)?-a.w:(this.anchor.size.w-this.anchor.offset.x);return e},setBackgroundColor:function(){},CLASS_NAME:"GCUI.Popup.Anchored"});OpenLayers.Control.LoadingPanel=OpenLayers.Class(OpenLayers.Control,{counter:0,maximized:false,onlySingleTile:true,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a])
},toggle:function(){this.setVisible(!this.getVisible())},addLayer:function(a){var b=a.layer;if(this.checkLayer(b)){b.events.register("loadstart",this,this.increaseCounter);b.events.register("loadend",this,this.decreaseCounter)}},checkLayer:function(a){return a&&(this.onlySingleTile?a.singleTile:true)
},setMap:function(b){OpenLayers.Control.prototype.setMap.apply(this,[b]);this.map.events.register("preaddlayer",this,this.addLayer);for(var a=0;a<this.map.layers.length;a++){this.addLayer({layer:this.map.layers[a]})}},increaseCounter:function(){this.counter++;if(this.counter>0){this.show()}},decreaseCounter:function(){if(this.counter>0){this.counter--
}if(this.counter===0){this.hide()}},hide:function(a){this.div.style.display="none";this.maximized=false;if(a!=null){OpenLayers.Event.stop(a)}},show:function(a){this.div.style.display="block";this.maximized=true;if(a!=null){OpenLayers.Event.stop(a)}},destroy:function(){if(this.map){this.map.events.unregister("preaddlayer",this,this.addLayer);
if(this.map.layers){for(var b=0;b<this.map.layers.length;b++){var a=this.map.layers[b];a.events.unregister("loadstart",this,this.increaseCounter);a.events.unregister("loadend",this,this.decreaseCounter)}}}OpenLayers.Control.prototype.destroy.apply(this,[])},CLASS_NAME:"OpenLayers.Control.LoadingPanel"});
GCUI.Control.Tour=OpenLayers.Class(OpenLayers.Control,{layer:null,url:null,steps:[],initialize:function(a,b){OpenLayers.Control.prototype.initialize.apply(this,[b]);this.steps=a},display:function(){if(!this.layer){this.routelayer=new OpenLayers.Layer.Vector("routeLayer"+this.id,{displayInLayerSwitcher:false,style:{strokeColor:"#1BE01B",strokeWidth:2}});
this.map.addLayer(this.routelayer);this.layer=new OpenLayers.Layer.Vector("Marker");this.map.addLayer(this.layer)}this.routelayer.removeAllFeatures();this.layer.removeAllFeatures();var a=new GCUI.Control.Route({autoActivate:true,layer:this.routelayer});this.map.addControl(a);var d=[];for(var c=0;c<this.steps.length;
c++){var f=this.steps[c];var e={fillColor:"#1080DD",strokeColor:"white",pointRadius:14,fontColor:"white",fontSize:"14px",fontFamily:"Arial,Verdana,sans-serif",labelSelect:true,label:""+(c+1)};var b=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(f.lon||f.x,f.lat||f.y).transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection(this.map.getProjection())),{},e);
this.layer.addFeatures(b);if(c>0&&c<this.steps.length-1){d.push(new OpenLayers.LonLat(f.lon||f.x,f.lat||f.y))}}var g=this;a.routes=[];a.route({origin:new OpenLayers.LonLat(this.steps[0].lon||this.steps[0].x,this.steps[0].lat||this.steps[0].y),destination:new OpenLayers.LonLat(this.steps[this.steps.length-1].lon||this.steps[this.steps.length-1].x,this.steps[this.steps.length-1].lat||this.steps[this.steps.length-1].y),waypoints:d,callback:function(i,h){a.displayRoute(i);
g.events.triggerEvent("route",{duration:i.duration,distance:i.distance});this.map.zoomToExtent(a.layer.getDataExtent())}})},optimize:function(a){var c=[];for(var b=0;b<this.steps.length;b++){var d=this.steps[b];c.push(d.id+","+(d.lon||d.x)+","+(d.lat||d.y))}var f=OpenLayers.Util.extend({url:this.url||(this.map?this.map.baseLayer.getUrlGC()+"/api/lbs/optim/route.json":""),params:{steps:c.join(";"),method:"TIME",provider:"SMARTROUTING"},handleResponse:function(h,g){this.destroyRequest(h.priv);
g.scope.steps=h.data.steps;g.scope.display()},scope:this},a);if(GCUI.Settings){OpenLayers.Util.applyDefaults(f.params,GCUI.Settings)}var e=new OpenLayers.Protocol.Script(f);e.read()},CLASS_NAME:"GCUI.Control.Tour"});GCUI.Map.Version="2.4.31";